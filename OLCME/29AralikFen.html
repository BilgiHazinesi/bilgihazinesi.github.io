<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>29 AralÄ±k Fen (GeliÅŸim OdaklÄ±)</title>
<style>
    :root { --primary: #27ae60; --dark: #2c3e50; --bg: #f4f7f6; --danger: #e74c3c; --blue: #3498db; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 140px; -webkit-tap-highlight-color: transparent; }
    
    /* GÄ°RÄ°Å EKRANI */
    #login-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--dark); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
    .class-btn { width: 200px; padding: 15px; margin: 10px; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; background: white; color: var(--dark); transition: 0.2s; }
    .loading-spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: none; margin-top: 20px;}
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* HEADER */
    header { background: var(--dark); color: white; padding: 10px 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    h1 { margin: 0; font-size: 1rem; font-weight: 600; }
    
    .btn-group { display: flex; gap: 5px; }
    .btn-mini { padding: 6px 10px; font-size: 0.75rem; border-radius: 4px; border: none; color: white; cursor: pointer; font-weight: bold; }
    .btn-edit { background: #3498db; }
    .btn-report { background: #f1c40f; color: #333; }
    .btn-sync { background: #e67e22; }

    /* ARAMA */
    .search-box { margin-bottom: 8px; position: relative; }
    .search-input { width: 100%; padding: 8px 10px; padding-left: 30px; border-radius: 6px; border: none; background: rgba(255,255,255,0.2); color: white; font-size: 0.9rem; outline: none; box-sizing: border-box; }
    .search-input::placeholder { color: rgba(255,255,255,0.6); }
    .search-icon { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); opacity: 0.6; font-size: 0.8rem; }

    /* LÄ°STE */
    .student-bar { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 5px; scrollbar-width: none; }
    .student-chip { 
        flex: 0 0 auto; background: rgba(255,255,255,0.15); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; 
        color: #ecf0f1; border: 1px solid transparent; cursor: pointer; transition: 0.3s;
    }
    .student-chip.active { background: var(--primary); color: white; font-weight: bold; transform: scale(1.05); border: 1px solid white; }
    .student-chip.done { color: var(--dark); background: #dcdde1; font-weight: 600; border: 1px solid #bdc3c7; opacity: 0.8; }
    .student-chip.done.active { background: var(--primary); color: white; opacity: 1; border: 1px solid white; }

    /* KARTLAR */
    .container { padding: 15px; max-width: 800px; margin: 0 auto; }
    .card { background: white; border-radius: 12px; padding: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #eee; transition: all 0.2s; }
    .card.filled { border-left-color: var(--primary); background: #f9fff9; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .q-title { font-weight: 700; color: var(--dark); font-size: 0.95rem; }
    .q-desc { font-size: 0.85rem; color: #666; margin-bottom: 10px; display: block; font-style: italic; }

    /* BUTONLAR */
    .btn-row { display: flex; gap: 8px; }
    .score-btn { 
        flex: 1; background: #f8f9fa; border: 2px solid #e0e0e0; padding: 12px 5px; border-radius: 8px; 
        text-align: center; font-weight: 700; color: #7f8c8d; cursor: pointer; font-size: 0.9rem; position: relative;
    }
    .score-btn.selected { background: var(--primary); color: white; border-color: #219150; box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3); transform: translateY(-2px); }
    .score-btn.selected::before { content: "âœ“ "; margin-right: 4px; font-weight: 900; }

    /* SAYAÃ‡ */
    .counter-wrapper { display: flex; align-items: center; justify-content: space-between; background: #f1f2f6; padding: 8px 12px; border-radius: 8px; border: 1px solid transparent; }
    .card.filled .counter-wrapper { border-color: #2ecc71; background: #e8f8f5; }
    .counter-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: white; font-size: 1.4rem; font-weight: bold; color: var(--dark); box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; }
    .counter-input { width: 70px; text-align: center; font-size: 1.3rem; font-weight: bold; border: 2px solid #ccc; border-radius: 6px; padding: 5px; color: var(--dark); background: white; }
    .card.filled .counter-input { border-color: var(--primary); color: var(--primary); }

    /* ALT PANEL */
    .bottom-bar { 
        position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; 
        padding: 15px; display: flex; flex-direction: column; gap: 12px; 
        box-shadow: 0 -4px 15px rgba(0,0,0,0.05); z-index: 90; box-sizing: border-box; 
    }
    .bottom-info { display: flex; justify-content: space-between; align-items: center; font-size: 1rem; color: #555; border-bottom: 1px solid #eee; padding-bottom: 8px;}
    .bottom-actions { display: flex; gap: 10px; }
    
    .btn-save { flex: 2; padding: 12px; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; font-size: 1rem; background: var(--dark); border: none; }
    .btn-extra { flex: 1; padding: 12px; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; font-size: 0.9rem; border: none; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .btn-karne { background: #8e44ad; }
    .btn-wa { background: #25D366; }

    /* MODAL */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center; }
    .modal-content { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
    textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-family: inherit; box-sizing: border-box; font-size:0.9rem; line-height:1.4; }

    /* RAPOR VE KARNE CSS */
    #report-screen { display: none; padding: 20px; background: white; min-height: 100vh; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 0.9rem; }
    th { background: #eee; }

    #individual-report { display: none; background: white; font-family: 'Times New Roman', serif; padding: 40px; color: black; }
    .ir-header { text-align: center; border-bottom: 2px solid #333; margin-bottom: 20px; padding-bottom: 10px; }
    .ir-title { font-size: 24px; font-weight: bold; margin: 5px 0; }
    .ir-info { display: flex; justify-content: space-between; margin-top: 20px; font-size: 14px; font-weight: bold; }
    .ir-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
    .ir-table th { background: #eee; text-align: left; padding: 8px; border: 1px solid #000; }
    .ir-table td { padding: 8px; border: 1px solid #000; }
    .ir-status { text-align: center; font-weight: bold; width: 100px; }
    .ir-footer { margin-top: 30px; border: 1px dashed #999; padding: 15px; font-size: 12px; line-height:1.5; text-align:justify; }
    .ir-sign { margin-top: 50px; text-align: right; font-weight: bold; margin-right: 20px; }

    @media print {
        body > * { display: none !important; }
        #individual-report { display: block !important; position: absolute; top: 0; left: 0; width: 100%; padding: 0; margin: 0; }
        #report-screen { display: block !important; position: absolute; top: 0; left: 0; width: 100%; padding: 0; margin: 0; }
        #app-content { display: none !important; }
    }
</style>
</head>
<body>

<div id="login-screen">
    <h2 style="margin-bottom:30px">SÄ±nÄ±f SeÃ§iniz</h2>
    <button class="class-btn" onclick="loadClass('A')">A SÄ±nÄ±fÄ±</button>
    <button class="class-btn" onclick="loadClass('B')">B SÄ±nÄ±fÄ±</button>
    <button class="class-btn" onclick="loadClass('C')">C SÄ±nÄ±fÄ±</button>
    <button class="class-btn" onclick="loadClass('D')">D SÄ±nÄ±fÄ±</button>
    <div id="spinner" class="loading-spinner"></div>
    <p id="status-text" style="margin-top:10px; font-size:0.9rem; color:#ccc;"></p>
</div>

<div id="app-content" style="display:none">
    <header id="main-header">
        <div class="header-top">
            <h1>ğŸ§ª 29 AralÄ±k Fen (<span id="activeClassDisplay"></span>)</h1>
            <div class="btn-group">
                <button class="btn-mini btn-edit" onclick="openEditModal()">âœï¸ Liste</button>
                <button class="btn-mini btn-report" onclick="showReport()">ğŸ“Š Rapor</button>
                <button class="btn-mini btn-sync" id="syncBtn" onclick="syncToCloud()">â˜ï¸ Kaydet</button>
            </div>
        </div>
        <div class="search-box">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="searchInput" class="search-input" placeholder="Ã–ÄŸrenci ara..." oninput="filterStudents()">
        </div>
        <div class="student-bar" id="studentList"></div>
    </header>

    <div class="container" id="rubricArea">
        <div style="text-align:center; margin-top:60px; color:#95a5a6;">
            <div style="font-size:40px; margin-bottom:10px;">ğŸ‘†</div>
            <h3>Listeden bir Ã¶ÄŸrenci seÃ§iniz</h3>
        </div>
    </div>

    <div class="bottom-bar" id="footer" style="display:none">
        <div class="bottom-info">
            <span><strong>Ã–ÄŸrenci:</strong> <span id="footerName" style="color:var(--dark)">-</span></span>
            <span style="font-size:0.9rem; color:var(--primary)">DeÄŸerlendirme Modu</span>
        </div>
        <div class="bottom-actions">
            <button class="btn-extra btn-karne" onclick="printIndividualReport()">ğŸ“„ Karne</button>
            <button class="btn-extra btn-wa" onclick="openWhatsappModal()">ğŸ’¬ Mesaj</button>
            <button class="btn-save" onclick="saveAndStay()">ğŸ’¾ Kaydet</button>
        </div>
    </div>
</div>

<div class="modal" id="waModal">
    <div class="modal-content">
        <h3>Veli Bilgilendirme MesajÄ±</h3>
        <textarea id="waText"></textarea>
        <div style="margin-top:10px; display:flex; gap:10px;">
            <button class="btn-mini" style="background:#25D366; flex:1; padding:10px" onclick="copyWa()">Kopyala</button>
            <button class="btn-mini" style="background:#95a5a6; flex:1; padding:10px" onclick="document.getElementById('waModal').style.display='none'">Kapat</button>
        </div>
    </div>
</div>

<div class="modal" id="editModal">
    <div class="modal-content">
        <h3>Ã–ÄŸrenci Listesi</h3>
        <textarea id="studentInput" placeholder="Ä°simleri alt alta yapÄ±ÅŸtÄ±rÄ±n..."></textarea>
        <div style="margin-top:10px; display:flex; gap:10px;">
            <button class="btn-mini btn-edit" onclick="saveStudentsLocal()">GeÃ§ici Kaydet</button>
            <button class="btn-mini" style="background:#95a5a6" onclick="document.getElementById('editModal').style.display='none'">Ä°ptal</button>
        </div>
        <p style="font-size:0.7rem; color:red; margin-top:5px;">Not: Listeyi kalÄ±cÄ± yapmak iÃ§in ana ekrandan "â˜ï¸ Kaydet" butonuna basmalÄ±sÄ±nÄ±z.</p>
    </div>
</div>

<div id="report-screen">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 id="report-title">Fen Bilimleri Puan Listesi</h2>
        <button class="btn-mini btn-edit no-print" onclick="closeReport()">Kapat</button>
    </div>
    <table id="score-table">
        <thead><tr><th>No</th><th>Ã–ÄŸrenci</th><th style="text-align:center">Puan</th></tr></thead>
        <tbody id="report-body"></tbody>
    </table>
</div>

<div id="individual-report">
    <div class="ir-header">
        <div style="font-size:14px; text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">Nesibe AydÄ±n OkullarÄ±</div>
        <div class="ir-title">DEÄERLENDÄ°RME KARNESÄ°</div>
        <div style="font-size:14px;">29 AralÄ±k Fen Bilimleri EtkinliÄŸi</div>
    </div>
    <div class="ir-info">
        <span>Ã–ÄŸrenci: <span id="ir-name"></span></span>
        <span>SÄ±nÄ±f: 4/<span id="ir-class-suffix"></span></span>
        <span>Tarih: <span id="ir-date"></span></span>
    </div>
    <table class="ir-table">
        <thead>
            <tr>
                <th style="width:20%">Ders</th>
                <th>Soru / KazanÄ±m</th>
                <th class="ir-status">Durum</th>
            </tr>
        </thead>
        <tbody id="ir-tbody"></tbody>
    </table>
    <div class="ir-footer">
        <strong>Ã–ÄŸretmen GÃ¶rÃ¼ÅŸÃ¼:</strong><br><br>
        <span id="ir-comment"></span>
    </div>
    <div class="ir-sign">
        <br>
        SÄ±nÄ±f Ã–ÄŸretmeni
    </div>
</div>

<script>
    // --- GOOGLE SCRIPT LINKI ---
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxGFreI0RG9kigA6LYfdFrDwkw4QNxEpqCbMSnFnRQLpH1KX-CuUKZ5knIV1fgEQTfT7Q/exec"; 

    let activeClass = ""; 
    let students = [];
    let db = {};
    let currentStudent = null;

    // 16 MADDELÄ°K FÄ°NAL YAPI
    const questions = [
        { id: 'q1', title: '1a. Madenler (BakÄ±r)', max: 3, type: 'toggle', desc: 'Turuncu renkli, kablolarda kullanÄ±lÄ±r' },
        { id: 'q2', title: '1b. Madenler (Krom)', max: 3, type: 'toggle', desc: 'Paslanmaz, musluklarda kullanÄ±lÄ±r' },
        { id: 'q3', title: '1c. Madenler (Mermer)', max: 3, type: 'toggle', desc: 'Zemin dÃ¶ÅŸemesi, mutfak tezgahÄ±' },
        { id: 'q4', title: '2a. KÃ¼tle Ã–lÃ§Ã¼mÃ¼', max: 2, type: 'toggle', desc: 'KÃ¼tleler eÅŸittir' },
        { id: 'q5', title: '2b. 1. TaÅŸ Hacmi', max: 2, type: 'toggle', desc: '160 mL' },
        { id: 'q6', title: '2c. 2. TaÅŸ Hacmi', max: 2, type: 'toggle', desc: '340 mL' },
        { id: 'q7', title: '2d. Deney Yorumu', max: 4, type: 'toggle', desc: 'Åekil/KapladÄ±ÄŸÄ± yer farkÄ±' },
        { id: 'q8', title: '3. Madde Ã–zellikleri', max: 13, type: 'counter', mult: 1, desc: 'Tablo iÅŸaretleme' },
        { id: 'q9', title: '4. Dengeli Beslenme', max: 10, type: 'multi', parts:[{l:'Ã–ÄŸÃ¼n',v:1}, {l:'MenÃ¼',v:4}, {l:'AÃ§Ä±klama',v:5}], desc: 'Ã–ÄŸÃ¼n, iÃ§erik ve denge aÃ§Ä±klamasÄ±' },
        { id: 'q10', title: '5. BoÅŸluk Doldurma', max: 14, type: 'counter', mult: 2, desc: 'BoÅŸluk doldurma' },
        { id: 'q11', title: '6. Kuvvetin Etkileri', max: 12, type: 'counter', mult: 3, desc: 'YÃ¶n, Åekil, HÄ±zlandÄ±rma, YavaÅŸlatma' },
        { id: 'q12', title: '7. Hareket Ã–rnekleri', max: 8, type: 'counter', mult: 2, desc: 'DÃ¶nme/Dolanma Ã¶rnekleri' },
        { id: 'q13', title: '8a. 1. Yay (Uzama)', max: 5, type: 'multi', parts:[{l:'Uzar',v:2},{l:'Neden',v:3}], desc: 'ZÄ±t kutuplar Ã§eker, yay uzar' },
        { id: 'q14', title: '8b. 2. Yay (KÄ±salma)', max: 5, type: 'multi', parts:[{l:'KÄ±salÄ±r',v:2},{l:'Neden',v:3}], desc: 'AynÄ± kutuplar iter, yay kÄ±salÄ±r' },
        { id: 'q15', title: '9. Hareket SonuÃ§larÄ±', max: 10, type: 'counter', mult: 2, desc: 'Gece-gÃ¼ndÃ¼z, Mevsimler vb.' },
        { id: 'q16', title: '10. Fosil OluÅŸumu', max: 4, type: 'counter', mult: 1, desc: 'SÄ±ralama' }
    ];

    // --- BAÅLANGIÃ‡ ---
    function loadClass(className) {
        activeClass = className;
        document.getElementById('spinner').style.display = 'block';
        document.getElementById('status-text').innerText = "Veriler Ã§ekiliyor...";
        
        fetch(GOOGLE_SCRIPT_URL + "?sinif=" + className)
        .then(response => response.json())
        .then(data => {
            if(data.status === 'error') {
                alert(data.msg);
                document.getElementById('spinner').style.display = 'none';
                return;
            }
            students = data.students || [];
            db = data.scores || {};
            startApp();
        })
        .catch(err => {
            alert("BaÄŸlantÄ± hatasÄ±!");
            document.getElementById('spinner').style.display = 'none';
        });
    }

    function startApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        document.getElementById('activeClassDisplay').innerText = activeClass + " Åubesi";
        sortAndRenderList();
    }

    function sortAndRenderList() {
        const list = document.getElementById('studentList');
        list.innerHTML = '';
        let displayList = [...students];
        displayList.sort((a, b) => {
            let aDone = db[a] && Object.keys(db[a]).length > 0 ? 1 : 0;
            let bDone = db[b] && Object.keys(db[b]).length > 0 ? 1 : 0;
            return aDone - bDone;
        });

        displayList.forEach(name => {
            const el = document.createElement('div');
            let isDone = db[name] && Object.keys(db[name]).length > 0;
            el.className = `student-chip ${isDone ? 'done' : ''}`;
            if(currentStudent === name) el.classList.add('active');
            const parts = name.split(" ");
            let shortName = parts[0] + (parts.length > 1 ? " " + parts[1][0] + "." : "");
            el.innerText = shortName;
            el.onclick = () => selectStudent(name);
            list.appendChild(el);
        });
    }

    function selectStudent(name) {
        currentStudent = name;
        document.getElementById('footerName').innerText = name;
        sortAndRenderList();
        renderRubric();
        document.getElementById('footer').style.display = 'flex';
        document.getElementById('rubricArea').scrollIntoView({behavior: 'smooth'});
    }

    function renderRubric() {
        const container = document.getElementById('rubricArea');
        container.innerHTML = `<h3 style="text-align:center; color:#2c3e50; margin-bottom:15px">${currentStudent}</h3>`;
        const data = db[currentStudent] || {};

        questions.forEach(q => {
            const card = document.createElement('div');
            let isFilled = false;
            if(q.type==='toggle' && data[q.id]===q.max) isFilled=true;
            if(q.type==='counter' && data[q.id]>0) isFilled=true;
            if(q.type==='multi' && data[q.id] && Object.values(data[q.id]).some(x=>x>0)) isFilled=true;

            card.className = `card ${isFilled?'filled':''}`;
            let html = `
                <div class="card-header">
                    <span class="q-title">${q.title}</span>
                    <span class="q-max">Max: ${q.max}p</span>
                </div>
                <span class="q-desc">${q.desc}</span>`;

            if(q.type === 'toggle') {
                const isSel = data[q.id] === q.max;
                html += `<div class="score-btn ${isSel?'selected':''}" onclick="toggleScore('${q.id}', ${q.max})">Tam Puan (${q.max})</div>`;
            }
            if(q.type === 'multi') {
                html += `<div class="btn-row">`;
                const sub = data[q.id] || {};
                q.parts.forEach((p, idx) => {
                    const isFull = sub[idx] === p.v;
                    html += `<div class="score-btn ${isFull?'selected':''}" onclick="togglePart('${q.id}', ${idx}, ${p.v})">${p.l}</div>`;
                });
                html += `</div>`;
            }
            if(q.type === 'counter') {
                const count = (data[q.id] || 0) / q.mult;
                const maxCount = q.max / q.mult;
                html += `
                <div class="counter-wrapper">
                    <button class="counter-btn" onclick="updCnt('${q.id}', -1, ${q.mult}, ${maxCount})">â–</button>
                    <input type="number" class="counter-input" id="inp_${q.id}" value="${count}" onfocus="this.select()" onchange="manualCnt('${q.id}', this.value, ${q.mult}, ${maxCount})">
                    <button class="counter-btn" style="color:var(--primary)" onclick="updCnt('${q.id}', 1, ${q.mult}, ${maxCount})">â•</button>
                    <div style="font-size:0.75rem; color:#7f8c8d; text-align:right">Adet<br>x${q.mult}p</div>
                </div>`;
            }
            card.innerHTML = html;
            container.appendChild(card);
        });
        container.innerHTML += '<div style="height:60px"></div>';
    }

    function toggleScore(id, max) { if(!db[currentStudent]) db[currentStudent] = {}; db[currentStudent][id] = (db[currentStudent][id] === max) ? 0 : max; saveLocal(); }
    function togglePart(id, idx, val) { if(!db[currentStudent]) db[currentStudent] = {}; if(!db[currentStudent][id]) db[currentStudent][id] = {}; const curr = db[currentStudent][id][idx] || 0; db[currentStudent][id][idx] = (curr === 0) ? val : 0; saveLocal(); }
    function updCnt(id, change, mult, maxCount) { if(!db[currentStudent]) db[currentStudent] = {}; let c = (db[currentStudent][id] || 0) / mult; c += change; if(c < 0) c = 0; if(c > maxCount) c = maxCount; manualCnt(id, c, mult, maxCount); }
    function manualCnt(id, val, mult, maxCount) { if(!db[currentStudent]) db[currentStudent] = {}; let c = parseInt(val); if(isNaN(c) || c < 0) c = 0; if(c > maxCount) c = maxCount; db[currentStudent][id] = c * mult; document.getElementById(`inp_${id}`).value = c; saveLocal(); }
    
    function saveLocal() { renderRubric(); }

    function saveAndStay() {
        sortAndRenderList();
    }

    function syncToCloud() {
        const btn = document.getElementById('syncBtn');
        btn.innerText = "â³";
        btn.disabled = true;
        const payload = { sinif: activeClass, data: { students: students, scores: db } };
        fetch(GOOGLE_SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) })
        .then(res => res.json())
        .then(response => {
            btn.innerText = "â˜ï¸ Kaydet"; btn.disabled = false;
            if(response.status === 'success') alert("âœ… Buluta Kaydedildi!");
            else alert("âš ï¸ Hata: " + response.msg);
        })
        .catch(err => { btn.innerText = "â˜ï¸ Kaydet"; btn.disabled = false; alert("Hata!"); });
    }

    // --- WHATSAPP (PUANSIZ / GELÄ°ÅÄ°M ODAKLI) ---
    function openWhatsappModal() {
        const d = db[currentStudent] || {};
        let missingTopics = [];

        questions.forEach(q => {
            let score = 0;
            if(q.type === 'multi') Object.values(d[q.id]||{}).forEach(v => score += v);
            else score = (d[q.id]||0);

            if(score < q.max) {
                // BaÅŸlÄ±ktaki soru numarasÄ±nÄ± temizle (1a. vb)
                let topic = q.title.replace(/^\d+[a-z]?\.\s*/, '');
                missingTopics.push(topic);
            }
        });

        let msg = `SayÄ±n Velim,\n`;
        msg += `8 AralÄ±k Pazartesi gÃ¼nÃ¼ yapÄ±lan 2. deÄŸerlendirme sonuÃ§larÄ±na gÃ¶re Ã¶ÄŸrencim ${currentStudent}, `;

        if (missingTopics.length > 0) {
            msg += `${missingTopics.join(', ')} konularÄ±nda tekrar Ã§alÄ±ÅŸmalarÄ± yaparak kendini geliÅŸtirebilir.\n\n`;
            msg += `Ã–ÄŸrencim, konu tekrarlarÄ± ve konularla ilgili dikkatli ve anlayarak sorular Ã§Ã¶zerek baÅŸarÄ± grafiÄŸini yÃ¼kseltebilir. Bu konuda sizlerden de destek bekliyorum.\n`;
        } else {
            msg += `tÃ¼m kazanÄ±mlarÄ± baÅŸarÄ±yla tamamlamÄ±ÅŸtÄ±r. Gayretli Ã§alÄ±ÅŸmalarÄ±ndan dolayÄ± tebrik ederim.\n`;
        }

        msg += `\nSaygÄ±larÄ±mla,\nSÄ±nÄ±f Ã–ÄŸretmeni`;

        document.getElementById('waText').value = msg;
        document.getElementById('waModal').style.display = 'flex';
    }

    function copyWa() {
        const copyText = document.getElementById("waText");
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value);
        alert("Mesaj kopyalandÄ±!");
    }

    // --- BÄ°REYSEL KARNE (PUAN GÄ°ZLENDÄ° / Ä°MZA DÃœZELDÄ°) ---
    function printIndividualReport() {
        const d = db[currentStudent] || {};
        const tbody = document.getElementById('ir-tbody');
        tbody.innerHTML = '';
        
        let missingTopics = [];
        let totalScore = 0;

        questions.forEach(q => {
            let score = 0;
            if(q.type === 'multi') { Object.values(d[q.id]||{}).forEach(v=>score+=v); }
            else { score = (d[q.id]||0); }
            totalScore += score; // Skoru sadece eksik/tam tespiti iÃ§in tutuyoruz

            let status = "";
            let color = "black";
            if(score === q.max) { status = "Tam"; color = "green"; }
            else if(score === 0) { 
                status = "GeliÅŸmeli"; color = "red"; 
                missingTopics.push(q.title.replace(/^\d+[a-z]?\.\s*/, '')); 
            }
            else { 
                status = "KÄ±smen"; color = "orange"; 
                missingTopics.push(q.title.replace(/^\d+[a-z]?\.\s*/, '')); 
            }

            tbody.innerHTML += `
                <tr>
                    <td>FEN BÄ°LÄ°MLERÄ°</td>
                    <td>${q.title}<br><small>${q.desc}</small></td>
                    <td class="ir-status" style="color:${color}">${status}</td>
                </tr>`;
        });

        // PUANSIZ YORUM
        let comment = `SayÄ±n Velim,\n8 AralÄ±k deÄŸerlendirmesi sonucunda Ã¶ÄŸrencimiz ${currentStudent} ile ilgili gÃ¶zlemlerim ÅŸÃ¶yledir:\n\n`;
        
        if(missingTopics.length === 0) {
            comment += "Ã–ÄŸrencimiz konularÄ± mÃ¼kemmel dÃ¼zeyde kavramÄ±ÅŸtÄ±r. Gayretli Ã§alÄ±ÅŸmalarÄ±ndan dolayÄ± tebrik ederim.";
        } else if(missingTopics.length <= 3) {
            comment += `Genel durumu iyidir ancak ${missingTopics.join(', ')} konularÄ±nda tekrar Ã§alÄ±ÅŸmalarÄ± yaparak kendini geliÅŸtirebilir.\n\n`;
            comment += `Bu konularda evde yapacaÄŸÄ±nÄ±z tekrarlar faydalÄ± olacaktÄ±r.`;
        } else {
            comment += `Ã–ÄŸrencimizin ${missingTopics.slice(0,4).join(', ')} ve diÄŸer eksik olduÄŸu konularda yoÄŸun desteÄŸe ve tekrara ihtiyacÄ± vardÄ±r.`;
        }

        document.getElementById('ir-name').innerText = currentStudent;
        document.getElementById('ir-class-suffix').innerText = activeClass;
        document.getElementById('ir-date').innerText = new Date().toLocaleDateString();
        document.getElementById('ir-comment').innerText = comment;

        document.getElementById('individual-report').style.display = 'block'; 
        window.print();
        document.getElementById('individual-report').style.display = 'none'; 
    }

    // --- SINIF RAPORU ---
    function showReport() {
        const body = document.getElementById('report-body');
        document.getElementById('report-title').innerText = "Fen Bilimleri (" + activeClass + " Åubesi)";
        body.innerHTML = '';
        students.forEach((s, i) => {
            let t = 0;
            const d = db[s] || {};
            questions.forEach(q => {
                if(q.type==='multi') { Object.values(d[q.id]||{}).forEach(v=>t+=v); }
                else { t += (d[q.id]||0); }
            });
            body.innerHTML += `<tr><td>${i+1}</td><td>${s}</td><td style="text-align:center; font-weight:bold">${t}</td></tr>`;
        });
        document.getElementById('app-content').style.display='none';
        document.getElementById('report-screen').style.display='block';
    }
    
    function closeReport() {
        document.getElementById('report-screen').style.display='none';
        document.getElementById('app-content').style.display='block';
    }

    function openEditModal() { document.getElementById('studentInput').value = students.join('\n'); document.getElementById('editModal').style.display = 'flex'; }
    function saveStudentsLocal() {
        const val = document.getElementById('studentInput').value;
        const lines = val.split('\n').map(x=>x.trim()).filter(x=>x);
        if(lines.length > 0) {
            students = lines;
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('searchInput').value = "";
            sortAndRenderList();
        }
    }

</script>
</body>
</html>
