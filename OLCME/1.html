<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>29 AralÄ±k Fen (Final)</title>
<style>
    :root { --primary: #27ae60; --dark: #2c3e50; --bg: #f4f7f6; --danger: #e74c3c; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
    
    /* ÃœST PANEL */
    header { background: var(--dark); color: white; padding: 10px 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    h1 { margin: 0; font-size: 1rem; font-weight: 600; }
    
    .btn-group { display: flex; gap: 5px; }
    .btn-mini { padding: 6px 10px; font-size: 0.75rem; border-radius: 4px; border: none; color: white; cursor: pointer; font-weight: bold; }
    .btn-edit { background: #3498db; }
    .btn-report { background: #f1c40f; color: #333; }
    .btn-backup { background: #e67e22; }

    /* ARAMA */
    .search-box { margin-bottom: 8px; position: relative; }
    .search-input { 
        width: 100%; padding: 8px 10px; padding-left: 30px; border-radius: 6px; border: none; 
        background: rgba(255,255,255,0.2); color: white; font-size: 0.9rem; outline: none; box-sizing: border-box;
    }
    .search-input::placeholder { color: rgba(255,255,255,0.6); }
    .search-icon { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); opacity: 0.6; font-size: 0.8rem; }

    /* Ã–ÄRENCÄ° LÄ°STESÄ° */
    .student-bar { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 5px; -webkit-overflow-scrolling: touch; scrollbar-width: none; min-height: 40px; }
    .student-bar::-webkit-scrollbar { display: none; }
    .student-chip { 
        flex: 0 0 auto; background: rgba(255,255,255,0.15); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; 
        color: #ecf0f1; border: 1px solid transparent; transition: 0.1s; cursor: pointer; user-select: none; white-space: nowrap;
    }
    .student-chip.active { background: var(--primary); color: white; font-weight: bold; transform: scale(1.05); box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 1px solid white; }
    .student-chip.done { color: var(--primary); background: white; font-weight: 600; }

    /* KARTLAR */
    .container { padding: 15px; max-width: 800px; margin: 0 auto; }
    .card { background: white; border-radius: 12px; padding: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #eee; transition: all 0.2s; }
    .card.filled { border-left-color: var(--primary); background: #f9fff9; }
    
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .q-title { font-weight: 700; color: var(--dark); font-size: 0.95rem; }
    .q-max { background:#ecf0f1; padding:2px 6px; border-radius:4px; font-size:0.75rem; color:#7f8c8d; font-weight:bold; }
    .q-desc { font-size: 0.85rem; color: #666; margin-bottom: 10px; display: block; font-style: italic; }

    /* BUTONLAR (GÃ–RSEL GELÄ°ÅTÄ°RÄ°LMÄ°Å) */
    .btn-row { display: flex; gap: 8px; }
    .score-btn { 
        flex: 1; background: #f8f9fa; border: 2px solid #e0e0e0; padding: 12px 5px; border-radius: 8px; 
        text-align: center; font-weight: 700; color: #7f8c8d; cursor: pointer; font-size: 0.9rem;
        transition: all 0.15s; position: relative;
    }
    .score-btn:active { transform: scale(0.96); }
    .score-btn.selected { 
        background: var(--primary); color: white; border-color: #219150; 
        box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3); transform: translateY(-2px);
    }
    .score-btn.selected::before { content: "âœ“ "; margin-right: 4px; font-weight: 900; }

    /* SAYAÃ‡ & KLAVYE GÄ°RÄ°ÅÄ° */
    .counter-wrapper { display: flex; align-items: center; justify-content: space-between; background: #f1f2f6; padding: 8px 12px; border-radius: 8px; border: 1px solid transparent; }
    .card.filled .counter-wrapper { border-color: #2ecc71; background: #e8f8f5; }
    
    .counter-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: white; font-size: 1.4rem; font-weight: bold; color: var(--dark); box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition:0.2s; }
    .counter-btn:active { transform: scale(0.9); }

    .counter-input { 
        width: 70px; text-align: center; font-size: 1.3rem; font-weight: bold; 
        border: 2px solid #ccc; border-radius: 6px; padding: 5px; color: var(--dark); background: white;
        transition: 0.2s;
    }
    .counter-input:focus { border-color: var(--primary); outline: none; transform: scale(1.05); }
    .card.filled .counter-input { border-color: var(--primary); color: var(--primary); }

    /* ALT PANEL */
    .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -4px 15px rgba(0,0,0,0.05); z-index: 90; box-sizing: border-box; }
    .btn-save { border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; font-size: 1rem; background: var(--dark); }

    /* MODAL */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center; }
    .modal-content { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; }
    textarea { width: 100%; height: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-family: inherit; box-sizing: border-box; }

    /* RAPOR */
    #report-screen { display: none; padding: 20px; background: white; min-height: 100vh; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 0.9rem; }
    th { background: #eee; }

    @media print {
        body * { visibility: hidden; }
        #report-screen, #report-screen * { visibility: visible; }
        #report-screen { position: absolute; left: 0; top: 0; width: 100%; display: block !important; padding: 0; }
        .no-print { display: none !important; }
    }
</style>
</head>
<body>

<header id="main-header">
    <div class="header-top">
        <h1>ğŸ§ª 29 AralÄ±k Fen (DÃ¼zeltilmiÅŸ)</h1>
        <div class="btn-group">
            <button class="btn-mini btn-edit" onclick="openEditModal()">âœï¸ Liste</button>
            <button class="btn-mini btn-report" onclick="showReport()">ğŸ“Š Rapor</button>
            <button class="btn-mini btn-backup" onclick="downloadData()">ğŸ’¾ Yedek</button>
            <button class="btn-mini" style="background:#8e44ad" onclick="document.getElementById('fileInput').click()">ğŸ“‚ YÃ¼kle</button>
        </div>
    </div>
    <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="searchInput" class="search-input" placeholder="Ã–ÄŸrenci ara..." oninput="filterStudents()">
    </div>
    <div class="student-bar" id="studentList"></div>
</header>

<div class="container" id="rubricArea">
    <div style="text-align:center; margin-top:60px; color:#95a5a6;">
        <div style="font-size:40px; margin-bottom:10px;">ğŸ‘†</div>
        <h3>Ã–ÄŸrenci SeÃ§iniz</h3>
    </div>
</div>

<div class="bottom-bar" id="footer" style="display:none">
    <div style="font-size:1.1rem; font-weight:800; color:#2c3e50">Toplam: <span id="totalScore" style="color:#27ae60">0</span> / 100</div>
    <button class="btn-save" onclick="finishStudent()">Kaydet & Sonraki â–¶</button>
</div>

<div id="report-screen">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Fen Bilimleri Puan Listesi</h2>
        <button class="btn-mini btn-edit no-print" onclick="closeReport()">Kapat</button>
    </div>
    <table id="score-table">
        <thead>
            <tr><th>No</th><th>Ã–ÄŸrenci</th><th style="text-align:center">Puan</th></tr>
        </thead>
        <tbody id="report-body"></tbody>
    </table>
</div>

<div class="modal" id="editModal">
    <div class="modal-content">
        <h3>Ã–ÄŸrenci Listesi</h3>
        <textarea id="studentInput" placeholder="Ä°simleri alt alta yapÄ±ÅŸtÄ±rÄ±n..."></textarea>
        <div style="margin-top:10px; display:flex; gap:10px;">
            <button class="btn-mini btn-edit" onclick="saveStudents()">Kaydet</button>
            <button class="btn-mini" style="background:#95a5a6" onclick="document.getElementById('editModal').style.display='none'">Ä°ptal</button>
        </div>
    </div>
</div>

<input type="file" id="fileInput" style="display:none" onchange="uploadData(this)">

<script>
    // --- VERÄ°LER ---
    let students = JSON.parse(localStorage.getItem('my_students_final_list')) || [
        "HAKAN AKDENÄ°Z", "HÃœSEYÄ°N Ã‡AÄAN GÃœRGAH", "AHMET ARIN AÄTÃœRK", "DENÄ°Z GÃœNEY", "Ä°DÄ°L DEMÄ°RCÄ°", 
        "DURU AYKANAT", "DENÄ°Z KÄ°MYON", "KADÄ°R BERKTAÅ", "DOÄA BORA", "AHMET CEVDET KORKMAZ", 
        "GÃœLNÄ°HAL KARAKAÅ", "NÄ°L TÄ°RYAKÄ°", "MASAL DEFNE TEL", "EYLÃœL AFAT", "ELÄ°F ADA KEKEÃ‡", 
        "EYLÃœL MUTAF", "Ä°PEK MÄ°MAROÄLU", "YEKTA URAS DEMÄ°RER", "HAMZA KAAN Ã‡EVEN", "BEYZA DAÄDELEN", 
        "NAZ KARABAÄLI", "AYNUR BUDAK", "DURU BÃœKÃœN", "WAFA MAKANSSI"
    ];

    // 16 MADDELÄ°K FÄ°NAL YAPI (Q2 DÃœZELTÄ°LDÄ°)
    const questions = [
        // Soru 1: Madenler (3 parÃ§a)
        { id: 'q1', title: '1a. BakÄ±r', max: 3, type: 'toggle', desc: 'Turuncu renkli, kablolarda kullanÄ±lÄ±r' },
        { id: 'q2', title: '1b. Krom', max: 3, type: 'toggle', desc: 'Paslanmaz, musluklarda kullanÄ±lÄ±r' },
        { id: 'q3', title: '1c. Mermer', max: 3, type: 'toggle', desc: 'Zemin dÃ¶ÅŸemesi, mutfak tezgahÄ±' },

        // Soru 2: TaÅŸ Deneyi (4 AYRI KART - Ä°steÄŸiniz Ãœzerine)
        { id: 'q4', title: '2a. KÃ¼tle', max: 2, type: 'toggle', desc: 'KÃ¼tleler eÅŸittir (2p)' },
        { id: 'q5', title: '2b. 1. TaÅŸ Hacmi', max: 2, type: 'toggle', desc: '160 mL (2p)' },
        { id: 'q6', title: '2c. 2. TaÅŸ Hacmi', max: 2, type: 'toggle', desc: '340 mL (2p)' },
        { id: 'q7', title: '2d. Yorum', max: 4, type: 'toggle', desc: 'Åekil/KapladÄ±ÄŸÄ± yer farkÄ± (4p)' },

        // Soru 3: Tablo
        { id: 'q8', title: '3. Madde Ã–zellikleri', max: 13, type: 'counter', mult: 1, desc: 'Tablo iÅŸaretleme (Her doÄŸru 1p)' },

        // Soru 4: MenÃ¼ (3 ParÃ§alÄ± Tek Kart)
        { id: 'q9', title: '4. Dengeli Beslenme', max: 10, type: 'multi', parts:[{l:'Ã–ÄŸÃ¼n(1p)',v:1}, {l:'MenÃ¼(4p)',v:4}, {l:'AÃ§Ä±klama(5p)',v:5}], desc: 'Ã–ÄŸÃ¼n, iÃ§erik ve denge aÃ§Ä±klamasÄ±' },

        // Soru 5: BoÅŸluk Doldurma
        { id: 'q10', title: '5. BoÅŸluk Doldurma', max: 14, type: 'counter', mult: 2, desc: 'Her doÄŸru 2 puan (Toplam 7 kelime)' },

        // Soru 6: Kuvvet
        { id: 'q11', title: '6. Kuvvetin Etkileri', max: 12, type: 'counter', mult: 3, desc: 'YÃ¶n, Åekil, HÄ±zlandÄ±rma, YavaÅŸlatma (x3p)' },

        // Soru 7: DÃ¼nya Hareketleri
        { id: 'q12', title: '7. Hareket Ã–rnekleri', max: 8, type: 'counter', mult: 2, desc: 'DÃ¶nme/Dolanma Ã¶rnekleri (x2p)' },

        // Soru 8: MÄ±knatÄ±s ve Yaylar (Ä°KÄ°YE AYRILDI)
        { id: 'q13', title: '8a. 1. Yay (Uzama)', max: 5, type: 'multi', parts:[{l:'Uzar(2p)',v:2},{l:'Neden(3p)',v:3}], desc: 'ZÄ±t kutuplar Ã§eker, yay uzar' },
        { id: 'q14', title: '8b. 2. Yay (KÄ±salma)', max: 5, type: 'multi', parts:[{l:'KÄ±salÄ±r(2p)',v:2},{l:'Neden(3p)',v:3}], desc: 'AynÄ± kutuplar iter, yay kÄ±salÄ±r' },

        // Soru 9: DÃ¼nya SonuÃ§larÄ±
        { id: 'q15', title: '9. Hareket SonuÃ§larÄ±', max: 10, type: 'counter', mult: 2, desc: 'Gece-gÃ¼ndÃ¼z, Mevsimler vb. (x2p)' },

        // Soru 10: Fosil
        { id: 'q16', title: '10. Fosil OluÅŸumu', max: 4, type: 'counter', mult: 1, desc: 'SÄ±ralama (Her adÄ±m 1p)' }
    ];

    let db = JSON.parse(localStorage.getItem('fen_db_final_fix2')) || {};
    let currentStudent = null;

    function init() { renderStudentList(); }

    function renderStudentList(filterText = "") {
        const list = document.getElementById('studentList');
        list.innerHTML = '';
        if(students.length === 0) { list.innerHTML = '<span style="color:white; padding:10px;">Liste boÅŸ.</span>'; return; }
        
        const filtered = students.filter(s => s.toLocaleLowerCase('tr').includes(filterText.toLocaleLowerCase('tr')));

        filtered.forEach(name => {
            const el = document.createElement('div');
            el.className = `student-chip ${db[name] ? 'done' : ''}`;
            if(currentStudent === name) el.classList.add('active');
            
            const parts = name.split(" ");
            let shortName = parts[0] + (parts.length > 1 ? " " + parts[1][0] + "." : "");
            el.innerText = shortName;
            
            el.onclick = () => selectStudent(name);
            list.appendChild(el);
        });
    }

    function filterStudents() {
        renderStudentList(document.getElementById('searchInput').value);
    }

    function selectStudent(name) {
        currentStudent = name;
        renderStudentList(document.getElementById('searchInput').value);
        renderRubric();
        document.getElementById('footer').style.display = 'flex';
        calculateTotal();
    }

    function renderRubric() {
        const container = document.getElementById('rubricArea');
        container.innerHTML = `<h3 style="text-align:center; color:#2c3e50; margin-bottom:15px">${currentStudent}</h3>`;
        const data = db[currentStudent] || {};

        questions.forEach(q => {
            const card = document.createElement('div');
            let isFilled = false;
            if(q.type==='toggle' && data[q.id]===q.max) isFilled=true;
            if(q.type==='counter' && data[q.id]>0) isFilled=true;
            if(q.type==='multi' && data[q.id] && Object.values(data[q.id]).some(x=>x>0)) isFilled=true;

            card.className = `card ${isFilled?'filled':''}`;
            
            let html = `
                <div class="card-header">
                    <span class="q-title">${q.title}</span>
                    <span class="q-max">Max: ${q.max}p</span>
                </div>
                <span class="q-desc">${q.desc}</span>
            `;

            if(q.type === 'toggle') {
                const isSel = data[q.id] === q.max;
                html += `<div class="score-btn ${isSel?'selected':''}" onclick="toggleScore('${q.id}', ${q.max})">Tam Puan (${q.max})</div>`;
            }

            if(q.type === 'multi') {
                html += `<div class="btn-row">`;
                const sub = data[q.id] || {};
                q.parts.forEach((p, idx) => {
                    const isFull = sub[idx] === p.v;
                    html += `<div class="score-btn ${isFull?'selected':''}" onclick="togglePart('${q.id}', ${idx}, ${p.v})">${p.l}</div>`;
                });
                html += `</div>`;
            }

            if(q.type === 'counter') {
                const count = (data[q.id] || 0) / q.mult;
                const maxCount = q.max / q.mult;
                html += `
                <div class="counter-wrapper">
                    <button class="counter-btn" onclick="updCnt('${q.id}', -1, ${q.mult}, ${maxCount})">â–</button>
                    <input type="number" class="counter-input" id="inp_${q.id}" value="${count}" 
                           onfocus="this.select()" 
                           onchange="manualCnt('${q.id}', this.value, ${q.mult}, ${maxCount})">
                    <button class="counter-btn" style="color:var(--primary)" onclick="updCnt('${q.id}', 1, ${q.mult}, ${maxCount})">â•</button>
                    <div style="font-size:0.75rem; color:#7f8c8d; text-align:right">Adet<br>x${q.mult}p</div>
                </div>`;
            }

            card.innerHTML = html;
            container.appendChild(card);
        });
        container.innerHTML += '<div style="height:60px"></div>';
    }

    function toggleScore(id, max) {
        if(!db[currentStudent]) db[currentStudent] = {};
        db[currentStudent][id] = (db[currentStudent][id] === max) ? 0 : max;
        save();
    }

    function togglePart(id, idx, val) {
        if(!db[currentStudent]) db[currentStudent] = {};
        if(!db[currentStudent][id]) db[currentStudent][id] = {};
        const curr = db[currentStudent][id][idx] || 0;
        db[currentStudent][id][idx] = (curr === 0) ? val : 0;
        save();
    }

    function updCnt(id, change, mult, maxCount) {
        if(!db[currentStudent]) db[currentStudent] = {};
        let c = (db[currentStudent][id] || 0) / mult;
        c += change;
        if(c < 0) c = 0; if(c > maxCount) c = maxCount;
        manualCnt(id, c, mult, maxCount);
    }

    function manualCnt(id, val, mult, maxCount) {
        if(!db[currentStudent]) db[currentStudent] = {};
        let c = parseInt(val);
        if(isNaN(c) || c < 0) c = 0;
        if(c > maxCount) c = maxCount;
        
        db[currentStudent][id] = c * mult;
        const inp = document.getElementById(`inp_${id}`);
        if(inp) inp.value = c;
        save();
    }

    function save() {
        localStorage.setItem('fen_db_final_fix2', JSON.stringify(db));
        calculateTotal();
        renderRubric();
    }

    function calculateTotal() {
        const data = db[currentStudent] || {};
        let total = 0;
        questions.forEach(q => {
            if(q.type === 'multi') {
                const sub = data[q.id] || {};
                Object.values(sub).forEach(v => total += v);
            } else {
                total += (data[q.id] || 0);
            }
        });
        document.getElementById('totalScore').innerText = total;
    }

    function finishStudent() {
        renderStudentList(document.getElementById('searchInput').value);
        const idx = students.indexOf(currentStudent);
        if(idx < students.length - 1) selectStudent(students[idx+1]);
        else alert("Liste sonu.");
    }

    function openEditModal() {
        document.getElementById('studentInput').value = students.join('\n');
        document.getElementById('editModal').style.display = 'flex';
    }
    function saveStudents() {
        const val = document.getElementById('studentInput').value;
        const lines = val.split('\n').map(x=>x.trim()).filter(x=>x);
        if(lines.length>0) {
            students = lines;
            localStorage.setItem('my_students_final_list', JSON.stringify(students));
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('searchInput').value = "";
            renderStudentList();
        }
    }

    function showReport() {
        const body = document.getElementById('report-body');
        body.innerHTML = '';
        students.forEach((s, i) => {
            let t = 0;
            const d = db[s] || {};
            questions.forEach(q => {
                if(q.type==='multi') { Object.values(d[q.id]||{}).forEach(v=>t+=v); }
                else { t += (d[q.id]||0); }
            });
            body.innerHTML += `<tr><td>${i+1}</td><td>${s}</td><td style="text-align:center; font-weight:bold">${t}</td></tr>`;
        });
        document.getElementById('main-header').style.display='none';
        document.getElementById('rubricArea').style.display='none';
        document.getElementById('footer').style.display='none';
        document.getElementById('report-screen').style.display='block';
    }
    function closeReport() {
        document.getElementById('report-screen').style.display='none';
        document.getElementById('main-header').style.display='block';
        document.getElementById('rubricArea').style.display='block';
        if(currentStudent) document.getElementById('footer').style.display='flex';
    }

    function downloadData() {
        const a = document.createElement('a');
        const data = {students, scores:db};
        a.href = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data));
        a.download = 'Fen_Final_Yedek.json';
        a.click();
    }
    document.getElementById('fileInput').onchange = (e) => {
        const r = new FileReader();
        r.onload = (evt) => {
            try {
                const d = JSON.parse(evt.target.result);
                if(d.students && d.scores) {
                    students = d.students; db = d.scores;
                    save(); renderStudentList();
                    alert("YÃ¼klendi.");
                }
            } catch(err){alert("Hata");}
        };
        r.readAsText(e.target.files[0]);
    };

    init();
</script>
</body>
</html>