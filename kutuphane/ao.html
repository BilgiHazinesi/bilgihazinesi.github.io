<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zeynal √ñƒüretmen (V66)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- PREMIUM KOYU TEMA (G√∂rseldeki Gibi) --- */
        :root {
            --bg: #0f172a; 
            --panel: #1e293b; 
            --border: rgba(255,255,255,0.1); 
            --primary: #3b82f6; 
            --text: #f8fafc;
            --subtext: #94a3b8;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; padding-bottom: 90px; }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 15px; display: none; }
        .glass-panel { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        
        /* HEADER */
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--panel); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        /* INPUT & BUTONLAR */
        .input-group { position: relative; margin-bottom: 10px; }
        input, select, textarea { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 10px; color: white; font-size: 0.95rem; box-sizing: border-box; }
        input:focus { border-color: var(--primary); outline: none; }
        
        .btn { padding: 10px 20px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; justify-content: center; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--subtext); }
        .btn:active { transform: scale(0.98); }
        
        /* Kƒ∞TAP Lƒ∞STESƒ∞ (G√∂rseldeki Gibi) */
        .book-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .book-info b { display: block; font-size: 1rem; color: #e2e8f0; margin-bottom: 4px; }
        .book-info span { font-size: 0.8rem; color: var(--subtext); }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; margin-left: 5px; }
        .bg-out { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .bg-in { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        
        /* Gƒ∞Rƒ∞≈û EKRANI */
        #loginOverlay { position: fixed; inset: 0; z-index: 9999; background: var(--bg); display: flex; justify-content: center; align-items: center; }
        .login-card { background: var(--panel); padding: 40px; border-radius: 24px; width: 90%; max-width: 350px; text-align: center; border: 1px solid var(--border); }

        /* NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 75px; background: var(--panel); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 900; }
        .nav-item { background: none; border: none; color: var(--subtext); font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.4rem; }
        
        .hidden { display: none !important; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- üî• YENƒ∞ UZAY YOLU (Yumu≈üak Kavisli) --- */
        .journey-container { position: relative; height: 350px; background: radial-gradient(circle at bottom, #1e293b, #000); border-radius: 20px; overflow: hidden; margin-top: 20px; border: 1px solid var(--border); }
        .stars { position: absolute; inset:0; background: url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/stars.png'); opacity: 0.5; }
        .station { position: absolute; width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); display: flex; flex-direction: column; align-items: center; justify-content: center; transform: translate(-50%, -50%); z-index: 2; font-size: 0.7rem; text-align: center; color: #cbd5e1; backdrop-filter: blur(4px); }
        .station.active { background: var(--primary); border-color: white; color: white; box-shadow: 0 0 20px var(--primary); transform: translate(-50%, -50%) scale(1.1); z-index: 3; }
        .astronaut { position: absolute; font-size: 2.5rem; transform: translate(-50%, -70%); filter: drop-shadow(0 0 10px gold); z-index: 10; transition: all 1s ease-in-out; }

        /* --- üå≥ YENƒ∞ ALTIGEN AƒûA√á --- */
        .tree-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .tree-card { background: #1e293b; width: 100%; max-width: 500px; border-radius: 24px; padding: 20px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border); }
        .tree-visual { position: relative; width: 100%; height: 350px; background: linear-gradient(to bottom, #87CEEB, #4CAF50); border-radius: 20px; overflow: hidden; margin-bottom: 20px; }
        .tree-svg { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; height: 90%; }
        .fruit { position: absolute; font-size: 1.8rem; z-index: 10; cursor: pointer; transition: 0.2s; }
        .fruit:hover { transform: scale(1.3); }
        .review-box { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 1px solid var(--border); }
        
        /* ETƒ∞KETLER */
        .filter-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--subtext); cursor: pointer; margin-right: 5px; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <h2>√ñƒüretmen Giri≈üi</h2>
        <div class="input-group"><input type="password" id="authCode" placeholder="≈ûifre" style="text-align:center; letter-spacing:3px;"></div>
        <button class="btn btn-primary" style="width:100%;" onclick="login()">Giri≈ü Yap</button>
        <div id="loader" style="display:none; margin-top:15px; color:var(--primary);">Y√ºkleniyor...</div>
    </div>
</div>

<div id="app" class="container">
    <div class="app-header">
        <h3 style="margin:0;">K√ºt√ºphane <span id="clsName" style="font-size:0.8rem; opacity:0.7;"></span></h3>
        <button class="btn btn-outline" style="padding:5px 10px;" onclick="location.reload()"><i class="fas fa-sign-out-alt"></i></button>
    </div>

    <div id="tab-home" class="tab-content active">
        <div class="glass-panel">
            <h4>Hƒ±zlƒ± Kitap Ver / ƒ∞≈ülem</h4>
            <div style="position:relative;">
                <input type="text" id="studentInput" placeholder="√ñƒürenci Adƒ± Yaz..." oninput="instantSearch(this.value)">
                <i class="fas fa-times" style="position:absolute; right:10px; top:12px; cursor:pointer;" onclick="clearInp()"></i>
            </div>
            <div id="instantResults" style="margin-top:15px;"></div>
        </div>
        
        <div id="lendPanel" class="glass-panel hidden">
            <h4>Kitap Se√ß & Ver</h4>
            <input list="bookList" id="bookInput" placeholder="Kitap Se√ß...">
            <datalist id="bookList"></datalist>
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="lend()">Teslim Et</button>
        </div>
        
        <div class="glass-panel">
            <div class="list-header">Son Hareketler</div>
            <div id="activeList"></div>
        </div>
    </div>

    <div id="tab-books" class="tab-content">
        <div class="glass-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <button class="filter-btn active" onclick="filterBooks('all', this)">T√ºm√º</button>
                <button class="filter-btn" onclick="filterBooks('out', this)">Dƒ±≈üarƒ±da</button>
                <button class="filter-btn" onclick="filterBooks('in', this)">Rafta</button>
            </div>
            <input type="text" id="bookSearch" placeholder="Kitap Ara..." oninput="renderBooks()">
            <div id="bookManagerList" style="margin-top:15px;"></div>
        </div>
    </div>

    <div id="tab-report" class="tab-content">
        <div class="glass-panel">
            <h4>Veli Raporu & Uzay</h4>
            <input list="studentList" id="repInput" placeholder="√ñƒürenci Se√ß..." onchange="genReport()">
            <datalist id="studentList"></datalist>
            
            <div id="reportView" class="hidden">
                <div id="reportText" style="background:rgba(255,255,255,0.1); padding:15px; border-radius:10px; white-space:pre-wrap; font-size:0.9rem; margin-top:15px; border:1px solid var(--border);"></div>
                <button class="btn btn-outline" style="margin-top:10px;" onclick="copyReport()">Kopyala</button>
                
                <div class="journey-container" id="journeyMap">
                    <div class="stars"></div>
                    <svg id="journeySvg" style="position:absolute; width:100%; height:100%; pointer-events:none;">
                        </svg>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-stats" class="tab-content">
        <div class="glass-panel">
            <h4>Liderlik Tablosu</h4>
            <div id="statsList"></div>
        </div>
    </div>

    <div id="tab-settings" class="tab-content">
        <div class="glass-panel">
            <h4>Kitap D√ºzenle / Ekle</h4>
            <div class="input-group">
                <input type="text" id="editBookSearch" placeholder="D√ºzenlenecek Kitap..." oninput="searchEdit(this.value)">
            </div>
            <div id="editForm" class="hidden" style="background:rgba(0,0,0,0.3); padding:15px; border-radius:10px; margin-bottom:15px;">
                <input type="hidden" id="oldName">
                <input id="newName" placeholder="Yeni Ad" style="margin-bottom:5px;">
                <input id="newPage" type="number" placeholder="Sayfa" style="margin-bottom:5px;">
                <button class="btn btn-primary" onclick="saveBookEdit()">G√ºncelle</button>
            </div>
            <hr style="border-color:var(--border); opacity:0.3;">
            <div style="display:flex; gap:5px;">
                <input id="nBook" placeholder="Yeni Kitap Adƒ±">
                <input id="nPage" type="number" placeholder="Sayfa" style="width:80px;">
            </div>
            <button class="btn btn-primary" style="width:100%; margin-top:5px;" onclick="addBook()">Ekle</button>
        </div>
        <div class="glass-panel">
            <h4>Sƒ±nƒ±f Hedefleri (Madalya)</h4>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="number" id="setS" placeholder="G√ºm√º≈ü">
                <input type="number" id="setG" placeholder="Altƒ±n">
            </div>
            <button class="btn btn-primary" style="width:100%;" onclick="saveSettings()">Kaydet</button>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <button class="nav-item active" onclick="tab('home',this)"><i class="fas fa-home"></i><span>Giri≈ü</span></button>
    <button class="nav-item" onclick="tab('books',this)"><i class="fas fa-book"></i><span>Kitap</span></button>
    <button class="nav-item" onclick="tab('report',this)"><i class="fas fa-rocket"></i><span>Rapor</span></button>
    <button class="nav-item" onclick="tab('stats',this)"><i class="fas fa-chart-bar"></i><span>Lider</span></button>
    <button class="nav-item" onclick="tab('settings',this)"><i class="fas fa-cog"></i><span>Ayar</span></button>
</div>

<div id="treeModal" class="tree-modal">
    <div class="tree-card">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <h3 style="margin:0;" id="treeTitle">Kitap</h3>
            <button onclick="document.getElementById('treeModal').style.display='none'" style="background:none; border:none; color:white; font-size:1.5rem;">&times;</button>
        </div>
        <div class="tree-visual" id="treeBox">
            <svg class="tree-svg" viewBox="0 0 400 400">
                <path d="M200,50 L330,120 L330,260 L200,330 L70,260 L70,120 Z" fill="#2e7d32" stroke="#4caf50" stroke-width="5"/>
                <rect x="180" y="330" width="40" height="70" fill="#5d4037" />
            </svg>
            <div id="fruits"></div>
        </div>
        <h4>Yorumlar</h4>
        <div id="reviewsList"></div>
    </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzc8B_Ig9E2_8oePzFwvDfgsyHQ-_7vF6H-m6DoTGlCub9MGbGOsUvoW6jkoPCmlfev/exec";
let data = {}, tempStudent = "";

const RANKS = [
    {c:0, t:"Ba≈ülangƒ±√ß"}, {c:5, t:"Okuma √áƒ±raƒüƒ±"}, {c:10, t:"Kitap Kurdu"},
    {c:15, t:"Bilgi Ka≈üifi"}, {c:20, t:"Kelime Avcƒ±sƒ±"}, {c:25, t:"K√ºt√ºphane Muhafƒ±zƒ±"},
    {c:30, t:"Edebiyat Ustasƒ±"}, {c:35, t:"Bilge Okur"}, {c:40, t:"EFSANE"}
];

function login() {
    let p = document.getElementById('authCode').value;
    if(!p) return;
    document.getElementById('loader').style.display='block';
    fetch(API + "?action=login_teacher&password=" + p).then(r=>r.json()).then(d=>{
        if(d.error) { alert(d.error); document.getElementById('loader').style.display='none'; }
        else { data=d; init(); }
    });
}

function init() {
    document.getElementById('loginOverlay').style.display='none';
    document.querySelector('.container').style.display='block';
    document.getElementById('clsName').innerText = "| " + data.userClass;
    
    // Datalistleri Doldur
    let sl=document.getElementById('studentList'); sl.innerHTML=""; data.students.forEach(s=>sl.innerHTML+=`<option value="${s}">`);
    let bl=document.getElementById('bookList'); bl.innerHTML=""; data.books.forEach(b=>bl.innerHTML+=`<option value="${b}">`);
    
    document.getElementById('setS').value = data.settings.silver;
    document.getElementById('setG').value = data.settings.gold;
    
    renderActive(); renderBooks(); renderStats();
}

// 1. Gƒ∞Rƒ∞≈û
function instantSearch(val) {
    let div = document.getElementById('instantResults');
    if(val.length < 2) { div.innerHTML=""; document.getElementById('lendPanel').classList.add('hidden'); return; }
    
    let recs = data.records.filter(r => r.student.toLowerCase().includes(val.toLowerCase()));
    
    // √ñƒürenci tam e≈üle≈üirse kitap verme panelini a√ß
    if(data.students.some(s => s.toLowerCase() === val.toLowerCase())) {
        tempStudent = data.students.find(s => s.toLowerCase() === val.toLowerCase());
        document.getElementById('lendPanel').classList.remove('hidden');
    } else {
        document.getElementById('lendPanel').classList.add('hidden');
    }

    if(recs.length === 0 && !tempStudent) { div.innerHTML = "<div style='text-align:center; opacity:0.5;'>Kayƒ±t yok</div>"; return; }
    
    let active = recs.find(r => r.status === "Okuyor");
    let hist = recs.filter(r => r.status === "ƒ∞ade Etti");
    
    let h = "";
    if(active) {
        h += `<div class="glass-panel" style="border:1px solid #facc15;">
            <b>${active.book}</b> <span style="color:#facc15">Okuyor</span>
            <button class="btn btn-danger" style="float:right; padding:5px 10px;" onclick="returnBook(${active.id})">ƒ∞ade Al</button>
        </div>`;
    }
    hist.forEach(r => {
        let icon = r.comment ? "‚úÖ" : "‚úèÔ∏è";
        h += `<div class="book-item">
            <div class="book-info"><b>${r.book}</b><span>${r.returnDate}</span></div>
            <span style="font-size:1.2rem;">${icon}</span>
        </div>`;
    });
    div.innerHTML = h;
}

function lend() {
    let b = document.getElementById('bookInput').value;
    if(!tempStudent || !b) return alert("√ñƒürenci veya Kitap se√ßilmedi");
    let p = {action:"lend", id:Date.now(), date:new Date().toLocaleDateString("tr-TR"), student:tempStudent, book:b};
    data.records.unshift({id:p.id, student:tempStudent, book:b, status:"Okuyor", date:"Bug√ºn"});
    instantSearch(tempStudent); renderActive(); document.getElementById('bookInput').value="";
    fetch(API, {method:"POST", body:JSON.stringify(p)});
}

function returnBook(id) {
    if(confirm("Kitap iade alƒ±ndƒ± mƒ±?")) {
        let r = data.records.find(x=>x.id==id);
        if(r) {
            r.status="ƒ∞ade Etti"; r.returnDate=new Date().toLocaleDateString("tr-TR");
            instantSearch(r.student); renderActive();
            fetch(API, {method:"POST", body:JSON.stringify({action:"return", id:id, returnDate:r.returnDate})});
        }
    }
}

function renderActive() {
    let div = document.getElementById('activeList'); div.innerHTML="";
    data.records.filter(r=>r.status==="Okuyor").forEach(r=>{
        div.innerHTML += `<div class="book-item">
            <div class="book-info"><b>${r.book}</b><span>${r.student}</span></div>
            <button class="btn btn-danger" style="padding:5px 10px;" onclick="returnBook(${r.id})">ƒ∞ade Al</button>
        </div>`;
    });
}

// 2. Kƒ∞TAPLAR (AƒûA√á)
let bFilter = 'all';
function filterBooks(f, btn) {
    bFilter = f; document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); renderBooks();
}
function renderBooks() {
    let div = document.getElementById('bookManagerList'); div.innerHTML="";
    let search = document.getElementById('bookSearch').value.toLowerCase();
    
    let list = data.books;
    if(search) list = list.filter(b => b.toLowerCase().includes(search));
    
    // Durumlarƒ± hesapla
    let out = data.records.filter(r=>r.status==="Okuyor").map(r=>r.book);
    let last = {}; data.records.forEach(r=>{if(r.status==="ƒ∞ade Etti") last[r.book]=r;});
    
    list.forEach(b => {
        let status = out.includes(b) ? 'out' : 'in';
        if(bFilter !== 'all' && status !== bFilter) return;
        
        let badge = status==='out' ? `<span class="badge bg-out">Dƒ±≈üarƒ±da</span>` : `<span class="badge bg-in">Rafta</span>`;
        let info = status==='in' && last[b] ? `<br><span>Son: ${last[b].student} (${last[b].returnDate})</span>` : '';
        
        let safe = b.replace(/'/g, "\\'");
        div.innerHTML += `<div class="book-item" onclick="openTree('${safe}')" style="cursor:pointer;">
            <div class="book-info"><b>${b}</b>${info}</div>
            <div style="text-align:right;">${badge}<br><small style="color:var(--primary)">Aƒüa√ß ‚ñ∂</small></div>
        </div>`;
    });
}

function openTree(bName) {
    document.getElementById('treeModal').style.display='flex';
    document.getElementById('treeTitle').innerText = bName;
    let cont = document.getElementById('fruits'); cont.innerHTML="";
    let rev = document.getElementById('reviewsList'); rev.innerHTML="";
    
    let readers = data.records.filter(r=>r.book===bName && r.status==="ƒ∞ade Etti");
    
    // Altƒ±gen Grid Yerle≈üimi
    readers.forEach((r, i) => {
        let f = document.createElement('div'); f.className='fruit';
        f.innerText = r.comment ? "üçé" : "üçè";
        
        // Basit Spiral Koordinat
        let angle = i * 2.4; 
        let rad = 30 + (i*5); if(rad>140) rad=140;
        let x = 200 + Math.cos(angle)*rad;
        let y = 180 + Math.sin(angle)*rad; // Y biraz yukarƒ±
        
        f.style.left = (x-20)+"px"; f.style.top = (y-20)+"px";
        cont.appendChild(f);
        
        rev.innerHTML += `<div class="review-box">
            <b>${r.student}</b> ${r.rating?"‚≠ê"+r.rating:""}<br>
            <small>${r.comment || "Yorumsuz"}</small>
        </div>`;
    });
}

// 3. RAPOR (YUMU≈ûAK KAVƒ∞S)
function genReport() {
    let s = document.getElementById('repInput').value; if(!s) return;
    let my = data.records.filter(r => r.student === s && r.status === "ƒ∞ade Etti");
    let act = data.records.find(r => r.student === s && r.status === "Okuyor");
    let p = 0; my.forEach(r => p += parseInt(data.bookPages[r.book])||0);
    
    let t = `Sayƒ±n Velimiz,\n\n‚ú® "Her kitap ke≈üfedilmeyi bekleyen ayrƒ± bir d√ºnyadƒ±r."\n\n√ñƒürencimiz *${s}*, bu d√∂nem k√ºt√ºphanemizden toplam *${my.length}* kitap okuyarak okuma yolculuƒüunu zenginle≈ütirmi≈ütir.\nToplam Okunan Sayfa: *${p}*\n\n`;
    if(act) t += `üî¥ *≈ûu An Okuduƒüu:*\n- ${act.book} (Alƒ±≈ü: ${act.date})\n\n`;
    t += `üìö *Ke≈üfettiƒüi D√ºnyalar:*\n`;
    my.forEach((r,i) => t += `${i+1}. ${r.book} (‚úÖ Okudu)\n`);
    t += `\nƒ∞lginiz ve desteƒüiniz i√ßin te≈üekk√ºr ederiz.\nZeynal √ñƒüretmen`;
    
    document.getElementById('reportView').classList.remove('hidden');
    document.getElementById('reportText').innerText = t;
    renderJourney(my.length);
}

function renderJourney(c) {
    let cont = document.getElementById('journeyMap');
    let svg = document.getElementById('journeySvg');
    cont.querySelectorAll('.station, .astronaut').forEach(e=>e.remove());
    svg.innerHTML = ""; // Temizle
    
    let w = cont.offsetWidth, h = 350;
    // YUMU≈ûAK S KIVRIMI
    let pathD = `M ${w*0.1} ${h*0.8} C ${w*0.4} ${h*0.8}, ${w*0.4} ${h*0.2}, ${w*0.9} ${h*0.2}`;
    
    let path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute("d", pathD);
    path.setAttribute("fill", "none");
    path.setAttribute("stroke", "rgba(255,255,255,0.3)");
    path.setAttribute("stroke-width", "4");
    path.setAttribute("stroke-dasharray", "8,8");
    svg.appendChild(path);
    
    // R√ºtbeler
    RANKS.forEach((r, i) => {
        let p = i / (RANKS.length-1);
        // Basit bezier eƒürisi noktasƒ± hesaplama (yakla≈üƒ±k)
        // P0=(0.1, 0.8), P1=(0.4, 0.8), P2=(0.4, 0.2), P3=(0.9, 0.2)
        let t = p;
        let x = w * (0.1*Math.pow(1-t,3) + 3*0.4*Math.pow(1-t,2)*t + 3*0.4*(1-t)*Math.pow(t,2) + 0.9*Math.pow(t,3));
        let y = h * (0.8*Math.pow(1-t,3) + 3*0.8*Math.pow(1-t,2)*t + 3*0.2*(1-t)*Math.pow(t,2) + 0.2*Math.pow(t,3));
        
        let st = document.createElement('div');
        st.className = `station ${c >= r.c ? 'active' : ''}`;
        st.style.left = x+"px"; st.style.top = y+"px";
        st.innerText = r.c;
        
        if(c >= r.c && (i===RANKS.length-1 || c < RANKS[i+1].c)) {
            let a = document.createElement('div'); a.className="astronaut"; a.innerText="üöÄ";
            a.style.left = x+"px"; a.style.top = (y-35)+"px";
            cont.appendChild(a);
        }
        cont.appendChild(st);
    });
}

// 4. ƒ∞STATƒ∞STƒ∞K
function renderStats() {
    let div = document.getElementById('statsList'); div.innerHTML="";
    let counts = {};
    data.records.forEach(r => { if(r.status==="ƒ∞ade Etti") {
        if(!counts[r.student]) counts[r.student] = {c:0, p:0};
        counts[r.student].c++; counts[r.student].p += parseInt(data.bookPages[r.book])||0;
    }});
    
    let sorted = Object.keys(counts).map(k => ({n:k, ...counts[k]})).sort((a,b) => b.c - a.c);
    
    sorted.forEach((s, i) => {
        let rank = RANKS[0].t;
        for(let j=0; j<RANKS.length; j++) if(s.c >= RANKS[j].c) rank = RANKS[j].t;
        // Madalya Birikimi
        let g = Math.floor(s.c / data.settings.gold);
        let si = Math.floor(s.c / data.settings.silver); // Toplam G√ºm√º≈ü (Altƒ±na d√∂n√º≈ümez)
        let medals = "ü•á".repeat(g) + "ü•à".repeat(si);
        
        div.innerHTML += `<div class="book-item">
            <div style="font-weight:bold; width:30px; color:var(--primary);">${i+1}</div>
            <div class="book-info"><b>${s.n}</b><span>${rank} ${medals}</span></div>
            <div style="text-align:right;"><b>${s.c}</b> Kitap<br><small>${s.p} syf</small></div>
        </div>`;
    });
}

// YARDIMCILAR
function tab(t,b) {
    document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
    document.getElementById('tab-'+t).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
    b.classList.add('active');
}
function clearInp(id) { 
    if(id) { document.getElementById(id).value=""; document.getElementById(id).focus(); }
    else { document.getElementById('studentInput').value=""; instantSearch(""); }
}
function copyReport() { navigator.clipboard.writeText(document.getElementById('reportText').innerText); alert("Kopyalandƒ±"); }
function toggleTheme() { document.body.classList.toggle('light-mode'); }

// D√úZENLEME & EKLEME
function searchEdit(val) {
    let f = document.getElementById('editForm');
    let b = data.books.find(x => x.toLowerCase() === val.toLowerCase());
    if(b) { f.classList.remove('hidden'); document.getElementById('oldName').value=b; document.getElementById('newName').value=b; document.getElementById('newPage').value=data.bookPages[b]||0; } 
    else f.classList.add('hidden');
}
function saveBookEdit() {
    let o=document.getElementById('oldName').value, n=document.getElementById('newName').value, p=document.getElementById('newPage').value;
    fetch(API, {method:"POST", body:JSON.stringify({action:"edit_book", oldName:o, newName:n, newPage:p})});
    alert("G√ºncellendi");
}
function addBook() {
    let n=document.getElementById('nBook').value, p=document.getElementById('nPage').value;
    if(n) fetch(API, {method:"POST", body:JSON.stringify({action:"add_book", name:n, page:p})});
    alert("Eklendi");
}
function addStudent() {
    let n=document.getElementById('newStudName').value, p=document.getElementById('newStudPass').value;
    if(n) fetch(API, {method:"POST", body:JSON.stringify({action:"add_student", name:n, pass:p})});
    alert("Eklendi");
}
function saveSettings() {
    let t=document.getElementById('setT').value, s=document.getElementById('setS').value, g=document.getElementById('setG').value;
    fetch(API, {method:"POST", body:JSON.stringify({action:"save_settings", target:t, silver:s, gold:g})});
    alert("Kaydedildi");
}
</script>
</body>
</html>
