<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zeynal √ñƒüretmen (Y√∂netici)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Y√ñNETƒ∞Cƒ∞ TEMASI --- */
        :root { --bg: #0f172a; --panel: #1e293b; --border: rgba(255,255,255,0.1); --primary: #3b82f6; --text: #f8fafc; --sub: #94a3b8; }
        body.light-mode { --bg: #f1f5f9; --panel: #ffffff; --border: rgba(0,0,0,0.1); --primary: #2563eb; --text: #1e293b; --sub: #64748b; }
        
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding-bottom: 90px; min-height: 100vh; transition: 0.3s; }
        
        .container { max-width: 800px; margin: 0 auto; padding: 20px; display: none; }
        .glass-panel { background: var(--panel); border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        
        .header { padding: 15px 20px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; background: var(--panel); border-bottom: 1px solid var(--border); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        input, select, textarea { width: 100%; padding: 12px; background: rgba(100,100,100,0.1); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 1rem; margin-bottom: 10px; }
        .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; background: var(--primary); color: white; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn:active { transform: scale(0.97); }
        .btn-outline { background: transparent; border: 1px solid var(--sub); color: var(--sub); width: auto; padding: 5px 10px; font-size: 0.8rem; }
        
        /* Lƒ∞STELER */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .item-info b { display: block; font-size: 1rem; }
        .item-info span { font-size: 0.8rem; color: var(--sub); }
        
        /* ≈ûƒ∞FRE Y√ñNETƒ∞Mƒ∞ */
        .pass-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .pass-row input { margin-bottom: 0; text-align: center; letter-spacing: 1px; font-family: monospace; }
        
        /* NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 80px; background: var(--panel); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: flex-start; padding-top: 15px; z-index: 900; }
        .nav-item { background: none; border: none; color: var(--sub); font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-item i { font-size: 1.4rem; }
        
        /* UZAY YOLU (W ≈ûEKLƒ∞) */
        .journey-container { position: relative; width: 100%; height: 500px; background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%); border-radius: 20px; overflow: hidden; margin-top: 20px; border: 2px solid rgba(255,255,255,0.2); }
        .stars { position: absolute; inset:0; background: url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/stars.png'); opacity: 0.6; }
        .svg-path { position: absolute; inset:0; width:100%; height:100%; }
        .station-node { position: absolute; width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.4); transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: white; z-index: 5; }
        .station-node.active { background: #3b82f6; border-color: white; box-shadow: 0 0 20px #3b82f6; }
        .astronaut { position: absolute; font-size: 2.5rem; transform: translate(-50%, -50%); z-index: 10; transition: all 1s; filter: drop-shadow(0 0 10px gold); }

        /* Gƒ∞Rƒ∞≈û */
        #loginOverlay { position: fixed; inset: 0; z-index: 999; background: var(--bg); display: flex; justify-content: center; align-items: center; }
        .login-card { background: var(--panel); padding: 40px; border-radius: 24px; width: 90%; max-width: 350px; text-align: center; border: 1px solid var(--border); }
        .hidden { display: none !important; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* AƒûA√á MODAL */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-card { background: var(--panel); width: 100%; max-width: 500px; border-radius: 24px; padding: 20px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border); position: relative; }
        .tree-visual { position: relative; width: 100%; height: 400px; background: linear-gradient(to bottom, #87CEEB, #4CAF50); border-radius: 20px; overflow: hidden; margin-bottom: 20px; }
        .tree-svg { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; height: 90%; }
        .fruit { position: absolute; font-size: 1.8rem; z-index: 10; cursor: pointer; transition: 0.2s; } .fruit:hover { transform: scale(1.3); }
        .review-card { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 1px solid var(--border); }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <h2>√ñƒüretmen Giri≈üi</h2>
        <input type="password" id="authCode" placeholder="Sƒ±nƒ±f ≈ûifresi" style="text-align:center; letter-spacing:3px;">
        <button class="btn" onclick="login()">Giri≈ü Yap</button>
        <div id="loader" style="display:none; margin-top:10px; color:var(--primary);">Y√ºkleniyor...</div>
    </div>
</div>

<div id="app" class="container">
    <div class="header">
        <h3 style="margin:0;">Zeynal √ñƒüretmen <span style="font-size:0.8rem; opacity:0.7;">| 4-D</span></h3>
        <button class="btn-outline" onclick="document.body.classList.toggle('light-mode')">üåì</button>
    </div>

    <div id="tab-home" class="tab-content active">
        <div class="glass-panel">
            <h3>Hƒ±zlƒ± Kitap Ver</h3>
            <input list="studentList" id="studentInput" placeholder="√ñƒürenci Se√ß...">
            <input list="bookList" id="bookInput" placeholder="Kitap Se√ß...">
            <datalist id="studentList"></datalist> <datalist id="bookList"></datalist>
            <button class="btn" onclick="lend()">Teslim Et</button>
        </div>
        <div class="glass-panel">
            <h3>Son Hareketler</h3>
            <div id="activeList"></div>
        </div>
    </div>

    <div id="tab-students" class="tab-content">
        <div class="glass-panel">
            <h3 style="color:var(--primary);">√ñƒürenci ≈ûifreleri üîë</h3>
            <p style="font-size:0.8rem; opacity:0.7;">≈ûifreleri buraya yazƒ±p en alttan kaydedin.</p>
            <div id="passwordList" style="max-height:400px; overflow-y:auto; margin-bottom:10px;"></div>
            <button class="btn" onclick="savePasswords()">T√ºm ≈ûifreleri Kaydet</button>
        </div>
        <div class="glass-panel">
            <h3>Yeni √ñƒürenci Ekle</h3>
            <input id="newStudName" placeholder="Ad Soyad">
            <button class="btn" onclick="addStudent()">Ekle</button>
        </div>
    </div>

    <div id="tab-books" class="tab-content">
        <div class="glass-panel">
            <h3>Kitaplƒ±k</h3>
            <input type="text" id="bookSearch" placeholder="Kitap Ara..." oninput="renderBooks()">
            <div id="bookListDiv"></div>
        </div>
    </div>

    <div id="tab-report" class="tab-content">
        <div class="glass-panel">
            <h3>Veli Raporu</h3>
            <input list="studentList" id="repInput" placeholder="√ñƒürenci Se√ß..." onchange="genReport()">
            <div id="reportView" class="hidden">
                <div id="reportText" style="background:rgba(255,255,255,0.1); padding:15px; border-radius:10px; white-space:pre-wrap; font-size:0.9rem; margin-top:15px; border:1px solid var(--border);"></div>
                <button class="btn btn-outline" style="margin-top:10px; width:100%;" onclick="copyReport()">Metni Kopyala</button>
                
                <div class="journey-container" id="journeyMap">
                    <div class="stars"></div>
                    <svg class="svg-path" id="journeySvg"></svg>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-settings" class="tab-content">
        <div class="glass-panel">
            <h3>Ayarlar</h3>
            <div style="display:flex; gap:10px;">
                <input type="number" id="setS" placeholder="G√ºm√º≈ü">
                <input type="number" id="setG" placeholder="Altƒ±n">
            </div>
            <button class="btn" onclick="saveSettings()">Kaydet</button>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <button class="nav-item active" onclick="tab('home',this)"><i class="fas fa-home"></i><span>Giri≈ü</span></button>
    <button class="nav-item" onclick="tab('students',this)"><i class="fas fa-users"></i><span>√ñƒürenci</span></button>
    <button class="nav-item" onclick="tab('books',this)"><i class="fas fa-book"></i><span>Kitap</span></button>
    <button class="nav-item" onclick="tab('report',this)"><i class="fas fa-rocket"></i><span>Rapor</span></button>
    <button class="nav-item" onclick="tab('settings',this)"><i class="fas fa-cog"></i><span>Ayar</span></button>
</div>

<div id="treeModal" class="overlay">
    <div class="modal-card">
        <button onclick="document.getElementById('treeModal').style.display='none'" style="float:right; background:none; border:none; color:white; font-size:1.5rem;">&times;</button>
        <h3 id="treeTitle" style="margin-top:0;">Kitap</h3>
        <div class="tree-visual" id="treeBox">
            <svg class="tree-svg" viewBox="0 0 400 400">
                <path d="M200,50 L330,120 L330,260 L200,330 L70,260 L70,120 Z" fill="#2e7d32" stroke="#4caf50" stroke-width="5"/>
                <rect x="180" y="330" width="40" height="70" fill="#5d4037" />
            </svg>
            <div id="fruits"></div>
        </div>
        <h4>Yorumlar</h4>
        <div id="reviewsList" style="max-height:200px; overflow-y:auto; text-align:left;"></div>
    </div>
</div>

<script>
    // --- API URL BURAYA ---
    const API = "https://script.google.com/macros/s/AKfycbz2gfpF6gPbip0i1KsYnYwnEbx3WkNy9OyYW3rYiIGWT13sBw-EM8cR7nquKgCzscO7/exec";
    
    let data = {}, userPass = "";
    const RANKS = [{c:0,t:"üå±"},{c:5,t:"ü•â"},{c:10,t:"üìñ"},{c:15,t:"üöÄ"},{c:20,t:"üèπ"},{c:25,t:"üëë"},{c:30,t:"üé©"},{c:35,t:"üåç"},{c:40,t:"üíé"}];

    function login() {
        let p = document.getElementById('authCode').value; if(!p) return;
        document.getElementById('loader').style.display='block';
        fetch(API + "?password=" + encodeURIComponent(p)).then(r=>r.json()).then(d=>{
            if(d.error) { alert(d.error); document.getElementById('loader').style.display='none'; }
            else { data=d; userPass=p; init(); }
        });
    }

    function init() {
        document.getElementById('loginOverlay').style.display='none';
        document.querySelector('.container').style.display='block';
        
        let sl=document.getElementById('studentList'); sl.innerHTML=""; 
        data.students.sort().forEach(s=>sl.innerHTML+=`<option value="${s}">`);
        let bl=document.getElementById('bookList'); bl.innerHTML=""; 
        data.books.sort().forEach(b=>bl.innerHTML+=`<option value="${b}">`);
        
        renderActive(); renderBooks(); renderPasswords();
    }

    // --- ≈ûƒ∞FRE Y√ñNETƒ∞Mƒ∞ ---
    function renderPasswords() {
        let div = document.getElementById('passwordList'); div.innerHTML="";
        if(!data.passwords) data.passwords = {};
        
        data.students.forEach(s => {
            let pass = data.passwords[s] || "";
            div.innerHTML += `
            <div class="pass-row">
                <div style="flex:2; font-weight:bold; font-size:0.9rem;">${s}</div>
                <input type="text" style="flex:1;" value="${pass}" placeholder="1234" id="pass-${s}">
            </div>`;
        });
    }
    
    function savePasswords() {
        data.students.forEach(s => {
            let val = document.getElementById(`pass-${s}`).value;
            if(val) data.passwords[s] = val;
        });
        
        fetch(API, {
            method: "POST", 
            body: JSON.stringify({ 
                action: "update_passwords", 
                passwords: data.passwords, 
                password: userPass 
            }) 
        });
        alert("≈ûifreler Kaydedildi!");
    }

    // --- Dƒ∞ƒûER FONKSƒ∞YONLAR ---
    function lend() {
        let s = document.getElementById('studentInput').value; let b = document.getElementById('bookInput').value;
        if(!s||!b) return;
        let p = {action:"lend", id:Date.now(), date:new Date().toLocaleDateString("tr-TR"), student:s, book:b, password:userPass};
        data.records.unshift({id:p.id, student:s, book:b, status:"Okuyor", date:"Bug√ºn"});
        renderActive(); document.getElementById('bookInput').value="";
        fetch(API, {method:"POST", body:JSON.stringify(p)});
    }

    function returnBook(id) {
        if(confirm("ƒ∞ade alƒ±nƒ±yor mu?")) {
            let r = data.records.find(x=>x.id==id);
            if(r) {
                r.status="ƒ∞ade Etti"; r.returnDate=new Date().toLocaleDateString("tr-TR");
                renderActive();
                fetch(API, {method:"POST", body:JSON.stringify({action:"return", id:id, returnDate:r.returnDate, password:userPass})});
            }
        }
    }

    function renderActive() {
        let div = document.getElementById('activeList'); div.innerHTML="";
        data.records.filter(r=>r.status==="Okuyor").forEach(r=>{
            div.innerHTML += `<div class="list-item">
                <div class="item-info"><b>${r.book}</b><span>${r.student}</span></div>
                <button class="btn-outline" onclick="returnBook(${r.id})">ƒ∞ade Al</button>
            </div>`;
        });
    }

    function renderBooks() {
        let val = document.getElementById('bookSearch').value.toLowerCase();
        let div = document.getElementById('bookListDiv'); div.innerHTML="";
        data.books.filter(b=>b.toLowerCase().includes(val)).forEach(b=>{
            let safe = b.replace(/'/g, "\\'");
            div.innerHTML += `<div class="list-item" onclick="openTree('${safe}')" style="cursor:pointer;">
                <div class="item-info"><b>${b}</b></div>
                <span style="color:var(--primary); font-size:0.8rem;">Aƒüa√ß ‚ñ∂</span>
            </div>`;
        });
    }

    function openTree(bName) {
        document.getElementById('treeModal').style.display='flex';
        document.getElementById('treeTitle').innerText = bName;
        let cont = document.getElementById('fruits'); cont.innerHTML="";
        let rev = document.getElementById('reviewsList'); rev.innerHTML="";
        
        let readers = data.records.filter(r=>r.book===bName && r.status==="ƒ∞ade Etti");
        
        readers.forEach((r, i) => {
            let f = document.createElement('div'); f.className='fruit'; f.innerText = r.comment?"üçé":"üçè";
            let angle = i * 2.4; let rad = 30 + (i*5); if(rad>140) rad=140;
            f.style.left = (200 + Math.cos(angle)*rad - 20)+"px";
            f.style.top = (180 + Math.sin(angle)*rad - 20)+"px";
            cont.appendChild(f);
            
            rev.innerHTML += `<div class="review-card"><b>${r.student}</b> ${r.rating?"‚≠ê"+r.rating:""}<br><small>${r.comment||""}</small></div>`;
        });
    }

    // --- RAPOR & UZAY ---
    function genReport() {
        let s = document.getElementById('repInput').value; if(!s) return;
        let my = data.records.filter(r=>r.student===s && r.status==="ƒ∞ade Etti");
        let act = data.records.find(r=>r.student===s && r.status==="Okuyor");
        let p = 0; my.forEach(r=>p+=parseInt(data.bookPages[r.book])||0);
        
        let t = `Sayƒ±n Velimiz,\n\n√ñƒürencimiz *${s}* toplam *${my.length}* kitap okumu≈ütur.\nToplam Sayfa: ${p}\n\n`;
        if(act) t += `üî¥ ≈ûu An: ${act.book}\n`;
        t += `\nüìö Ge√ßmi≈ü:\n`;
        my.forEach((r,i)=> t+=`${i+1}. ${r.book} (‚úÖ)\n`);
        
        document.getElementById('reportView').classList.remove('hidden');
        document.getElementById('reportText').innerText = t;
        renderMap(my.length);
    }

    function renderMap(c) {
        let cont = document.getElementById('journeyMap'); let svg = document.getElementById('journeySvg');
        cont.querySelectorAll('.station-node, .astronaut').forEach(e=>e.remove()); svg.innerHTML = "";
        
        let pts = [{x:15,y:90},{x:85,y:80},{x:15,y:65},{x:85,y:55},{x:15,y:40},{x:85,y:30},{x:15,y:20},{x:85,y:10},{x:50,y:5}];
        let w = cont.offsetWidth, h = 500;
        let d = `M ${w*pts[0].x/100} ${h*pts[0].y/100}`;
        for(let i=1; i<pts.length; i++) d += ` L ${w*pts[i].x/100} ${h*pts[i].y/100}`;
        
        let path = document.createElementNS("http://www.w3.org/2000/svg","path");
        path.setAttribute("d",d); path.setAttribute("fill","none"); path.setAttribute("stroke","rgba(255,255,255,0.3)"); path.setAttribute("stroke-width","4"); path.setAttribute("stroke-dasharray","8,8");
        svg.appendChild(path);
        
        pts.forEach((p,i) => {
            let rank = RANKS[i] || {t:"?",c:0};
            let st = document.createElement('div'); st.className = `station-node ${c>=rank.c?'active':''}`;
            st.style.left = p.x+"%"; st.style.top = p.y+"%"; st.innerText = rank.t;
            if(c>=rank.c && (i===pts.length-1 || c < (RANKS[i+1]?.c || 999))) {
                let a = document.createElement('div'); a.className="astronaut"; a.innerText="üë®‚ÄçüöÄ";
                a.style.left = p.x+"%"; a.style.top = (p.y-6)+"%"; cont.appendChild(a);
            }
            cont.appendChild(st);
        });
    }

    function tab(t,b) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); b.classList.add('active'); }
    function copyReport() { navigator.clipboard.writeText(document.getElementById('reportText').innerText); alert("Kopyalandƒ±"); }
    function addStudent() { let n = document.getElementById('newStudName').value.toUpperCase(); if(n) { data.students.push(n); data.students.sort(); init(); document.getElementById('newStudName').value=""; alert("Eklendi (Kaydetmeyi Unutma!)"); } }
    function saveSettings() { alert("Kaydedildi (Backend Gerekli)"); }
</script>
</body>
</html>
