<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>√ñƒüretmen Paneli (V65)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- V43 ESƒ∞NTƒ∞Lƒ∞ TASARIM --- */
        :root {
            --bg-dark: #0f172a; --panel-dark: rgba(30, 41, 59, 0.7); --border-dark: rgba(255,255,255,0.1);
            --bg-light: #f1f5f9; --panel-light: rgba(255, 255, 255, 0.8); --border-light: rgba(0,0,0,0.1);
            --primary: #3b82f6; --accent: #f59e0b; --danger: #ef4444; --success: #10b981;
            
            --bg: var(--bg-dark); --panel: var(--panel-dark); --border: var(--border-dark); --text: #f8fafc; --text-sub: #94a3b8;
        }
        body.light-mode {
            --bg: var(--bg-light); --panel: var(--panel-light); --border: var(--border-light); --text: #1e293b; --text-sub: #64748b;
        }
        
        * { box-sizing: border-box; outline: none; font-family: 'Segoe UI', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); padding-bottom: 90px; transition: 0.3s; min-height: 100vh; }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; display: none; }
        
        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--panel); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; border-radius: 0 0 20px 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .header h2 { margin: 0; font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .badge { background: var(--primary); padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; }
        
        /* PANEL */
        .glass-panel { background: var(--panel); border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin-bottom: 20px; backdrop-filter: blur(15px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        /* INPUTS */
        .input-group { position: relative; margin-bottom: 15px; }
        input, select, textarea { width: 100%; padding: 14px; background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-size: 1rem; transition: 0.3s; }
        body.light-mode input { background: rgba(255,255,255,0.8); }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .clear-btn { position: absolute; right: 15px; top: 15px; cursor: pointer; color: var(--text-sub); display: none; }
        
        /* BUTTONS */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #2563eb); color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        .btn-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-sub); }
        .btn:active { transform: scale(0.98); }
        
        /* LISTE G√ñR√úN√úM√ú */
        .list-header { font-size: 0.8rem; text-transform: uppercase; color: var(--text-sub); font-weight: 700; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .list-item:last-child { border-bottom: none; }
        .item-info b { display: block; font-size: 0.95rem; margin-bottom: 2px; }
        .item-info span { font-size: 0.8rem; color: var(--text-sub); display: flex; align-items: center; gap: 5px; }
        
        /* PROGRESS */
        .progress-bar { height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; overflow: hidden; margin-top: 5px; }
        body.light-mode .progress-bar { background: rgba(0,0,0,0.1); }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #8b5cf6, #3b82f6); width: 0%; transition: 1s; }
        
        /* UZAY YOLU (EƒûRƒ∞SEL) */
        .journey-map { position: relative; height: 350px; background: radial-gradient(ellipse at bottom, #1e293b, #0f172a); border-radius: 20px; overflow: hidden; margin-top: 15px; border: 1px solid var(--border); }
        .stars { position: absolute; inset: 0; background: url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/stars.png'); opacity: 0.5; }
        .station { position: absolute; width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; font-size: 0.7rem; transform: translate(-50%, -50%); transition: 0.3s; z-index: 2; backdrop-filter: blur(5px); }
        .station.active { background: var(--primary); border-color: white; color: white; box-shadow: 0 0 20px var(--primary); transform: translate(-50%, -50%) scale(1.1); }
        .astronaut { position: absolute; font-size: 2.5rem; transform: translate(-50%, -50%); filter: drop-shadow(0 0 10px gold); z-index: 5; transition: all 1.5s ease-in-out; }
        
        /* NAVBAR */
        .navbar { position: fixed; bottom: 0; width: 100%; height: 80px; background: var(--panel); backdrop-filter: blur(20px); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 900; }
        .nav-item { background: none; border: none; color: var(--text-sub); display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 0.7rem; opacity: 0.6; transition: 0.3s; cursor: pointer; }
        .nav-item.active { color: var(--primary); opacity: 1; transform: translateY(-5px); }
        .nav-item i { font-size: 1.5rem; }
        
        /* MODAL */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: #1e293b; padding: 25px; border-radius: 24px; width: 90%; max-width: 450px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        body.light-mode .modal { background: #fff; }
        
        .hidden { display: none !important; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
        
        /* R√úTBE ROZETLERƒ∞ */
        .rank-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.1); color: var(--accent); border: 1px solid var(--border); }
    </style>
</head>
<body>

<div id="loginOverlay" style="position:fixed; inset:0; z-index:2000; background:var(--bg); display:flex; justify-content:center; align-items:center;">
    <div class="glass-panel" style="width:90%; max-width:350px; text-align:center;">
        <h2>√ñƒüretmen Giri≈üi</h2>
        <div class="input-group"><input type="password" id="pass" placeholder="Sƒ±nƒ±f ≈ûifresi" style="text-align:center; letter-spacing:3px;"></div>
        <button class="btn btn-primary" onclick="login()">Giri≈ü Yap</button>
    </div>
</div>

<div id="app" class="container">
    <div class="header">
        <h2><i class="fas fa-book-reader"></i> <span id="headerTitle">Y√ºkleniyor...</span></h2>
        <button onclick="toggleTheme()" style="background:none; border:none; color:var(--text); font-size:1.2rem; cursor:pointer;">üåì</button>
    </div>

    <div id="tab-home" class="tab-content active">
        <div class="glass-panel">
            <h3>Hƒ±zlƒ± ƒ∞≈ülem</h3>
            <div class="input-group">
                <input type="text" list="sList" id="sInput" placeholder="√ñƒürenci Adƒ± Yaz..." oninput="handleSearch(this.value)">
                <i class="fas fa-times clear-btn" onclick="clearInp('sInput'); handleSearch('')"></i>
            </div>
            <div class="input-group">
                <input type="text" list="bList" id="bInput" placeholder="Kitap Se√ß...">
                <i class="fas fa-times clear-btn" onclick="clearInp('bInput')"></i>
            </div>
            <datalist id="sList"></datalist> <datalist id="bList"></datalist>
            <button class="btn btn-primary" onclick="lend()">Kitabƒ± Teslim Et</button>
        </div>

        <div id="searchResults" class="glass-panel hidden">
            <div class="list-header">√ñƒürenci Durumu</div>
            <div id="resContent"></div>
        </div>

        <div class="glass-panel">
            <div class="list-header"><span>Son Hareketler</span> <span id="syncStatus" style="font-size:0.7rem;">Senkronize</span></div>
            <div id="activeList"></div>
        </div>
    </div>

    <div id="tab-books" class="tab-content">
        <div class="glass-panel">
            <h3>Kitap Y√∂netimi</h3>
            <div class="input-group">
                <input id="newBookName" placeholder="Yeni Kitap Adƒ±">
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input id="newBookPage" type="number" placeholder="Sayfa" style="flex:1;">
                <button class="btn btn-primary" style="width:auto;" onclick="addBook()">Ekle</button>
            </div>
            <hr style="opacity:0.2; margin:15px 0;">
            <input type="text" id="bookSearch" placeholder="Kitap Ara / D√ºzenle..." oninput="renderBooks()">
            <div id="bookListDiv" style="margin-top:15px;"></div>
        </div>
    </div>

    <div id="tab-report" class="tab-content">
        <div class="glass-panel">
            <h3>Motivasyon Raporu</h3>
            <div class="input-group">
                <input type="text" list="sList" id="repInput" placeholder="√ñƒürenci Se√ß..." onchange="genReport()">
                <i class="fas fa-times clear-btn" onclick="clearInp('repInput')"></i>
            </div>
            
            <div id="reportView" class="hidden">
                <div id="reportText" style="background:rgba(0,0,0,0.2); padding:15px; border-radius:12px; font-size:0.9rem; white-space:pre-wrap; border:1px solid var(--border);"></div>
                <button class="btn btn-outline" style="margin-top:10px;" onclick="copyReport()"><i class="far fa-copy"></i> Kopyala</button>
                
                <div class="journey-map" id="journeyMap">
                    <div class="stars"></div>
                    <svg style="position:absolute; width:100%; height:100%;"><path id="journeyPath" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="3" stroke-dasharray="8,8" /></svg>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-stats" class="tab-content">
        <div class="glass-panel">
            <div class="list-header"><span>Sƒ±nƒ±f Hedefi</span> <span id="targetTxt">0/0</span></div>
            <div class="progress-bar"><div class="progress-fill" id="progBar"></div></div>
        </div>
        <div class="glass-panel">
            <h3>üèÜ Okuma Sƒ±ralamasƒ±</h3>
            <div id="statsList"></div>
        </div>
    </div>

    <div id="tab-settings" class="tab-content">
        <div class="glass-panel">
            <h3>‚öôÔ∏è Sƒ±nƒ±f Ayarlarƒ±</h3>
            <div class="input-group"><label>Hedef</label><input type="number" id="setT"></div>
            <div style="display:flex; gap:10px;">
                <div><label>G√ºm√º≈ü</label><input type="number" id="setS"></div>
                <div><label>Altƒ±n</label><input type="number" id="setG"></div>
            </div>
            <button class="btn btn-primary" style="margin-top:15px;" onclick="saveSettings()">Kaydet</button>
        </div>
        <div class="glass-panel">
            <h3>üë• √ñƒürenci Ekle</h3>
            <div class="input-group"><input id="newStudName" placeholder="Ad Soyad"></div>
            <div class="input-group"><input id="newStudPass" placeholder="≈ûifre"></div>
            <button class="btn btn-primary" onclick="addStudent()">Ekle</button>
        </div>
    </div>
</div>

<div class="navbar">
    <button class="nav-item active" onclick="tab('home',this)"><i class="fas fa-home"></i><span>Giri≈ü</span></button>
    <button class="nav-item" onclick="tab('books',this)"><i class="fas fa-book"></i><span>Kitaplar</span></button>
    <button class="nav-item" onclick="tab('report',this)"><i class="fas fa-rocket"></i><span>Rapor</span></button>
    <button class="nav-item" onclick="tab('stats',this)"><i class="fas fa-chart-pie"></i><span>ƒ∞statistik</span></button>
    <button class="nav-item" onclick="tab('settings',this)"><i class="fas fa-cog"></i><span>Ayarlar</span></button>
</div>

<div id="editModal" class="overlay">
    <div class="modal">
        <h3>D√ºzenle</h3>
        <input type="hidden" id="editId">
        <div style="margin-bottom:10px; font-weight:bold;" id="editTitle"></div>
        <div class="rating-group" style="display:flex; justify-content:center; gap:5px; margin-bottom:10px;">
            <button onclick="setRate(1)">1</button><button onclick="setRate(2)">2</button><button onclick="setRate(3)">3</button><button onclick="setRate(4)">4</button><button onclick="setRate(5)">5</button>
        </div>
        <select id="editCard" style="margin-bottom:10px;"></select>
        <textarea id="editComment" placeholder="Yorum..." style="height:80px; margin-bottom:10px;"></textarea>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-danger" onclick="document.getElementById('editModal').style.display='none'">ƒ∞ptal</button>
            <button class="btn btn-primary" onclick="saveEdit()">Kaydet</button>
        </div>
    </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyhgWUBb-Aj2gwBosZMVn15tH0q5-ACUqd3lEsIn9z-1iyL4OESsehoeU8zM4Vx14IN/exec";
let data = {}, tempRate = 0;

const RANKS = [
    {c:0, t:"üå± Ba≈ülangƒ±√ß"}, {c:5, t:"ü•â Okuma √áƒ±raƒüƒ±"}, {c:10, t:"üìñ Kitap Kurdu"},
    {c:15, t:"üöÄ Bilgi Ka≈üifi"}, {c:20, t:"üèπ Kelime Avcƒ±sƒ±"}, {c:25, t:"üëë K√ºt√ºphane Muhafƒ±zƒ±"},
    {c:30, t:"üé© Edebiyat Ustasƒ±"}, {c:35, t:"üåç Bilge Okur"}, {c:40, t:"üíé EFSANE"}
];
const CARDS = {
    "1":"Macera Hatƒ±rasƒ±", "2":"√ñƒürenen Profil", "3":"Duygu Kartƒ±", "4":"Baƒülantƒ± Kartƒ±",
    "5":"Ele≈ütiri Kartƒ±", "6":"Soru Kartƒ±", "7":"Yaratƒ±cƒ± Son", "8":"Geli≈üim", "9":"Tavsiye"
};

function login() {
    let p = document.getElementById('pass').value;
    if(!p) return;
    fetch(API + "?action=login_teacher&password=" + p).then(r=>r.json()).then(d=>{
        if(d.error) alert(d.error); else { data=d; init(); }
    });
}

function init() {
    document.getElementById('loginOverlay').style.display='none';
    document.querySelector('.container').style.display='block';
    document.getElementById('headerTitle').innerText = "√ñƒüretmen | " + data.userClass; // Sƒ±nƒ±f Adƒ±
    
    // Datalist
    let sl=document.getElementById('sList'); sl.innerHTML=""; data.students.forEach(s=>sl.innerHTML+=`<option value="${s}">`);
    let bl=document.getElementById('bList'); bl.innerHTML=""; data.books.forEach(b=>bl.innerHTML+=`<option value="${b}">`);
    
    // Ayarlar
    document.getElementById('setT').value = data.settings.target;
    document.getElementById('setS').value = data.settings.silver;
    document.getElementById('setG').value = data.settings.gold;
    
    // Kartlar
    let cs = document.getElementById('editCard');
    for(let k in CARDS) cs.innerHTML += `<option value="${k}">${CARDS[k]}</option>`;
    
    renderActive();
    renderStats();
    
    // Input X Butonlarƒ±
    document.querySelectorAll('input').forEach(i => {
        i.addEventListener('input', function(){
            let b = this.parentElement.querySelector('.clear-btn');
            if(b) b.style.display = this.value.length > 0 ? 'block' : 'none';
        });
    });
}

// 1. ANA SAYFA
function handleSearch(val) {
    let div = document.getElementById('searchResults');
    let cont = document.getElementById('resContent');
    if(val.length < 2) { div.classList.add('hidden'); return; }
    
    div.classList.remove('hidden');
    let recs = data.records.filter(r => r.student.toLowerCase().includes(val.toLowerCase()));
    
    if(recs.length === 0) { cont.innerHTML="<div style='text-align:center; opacity:0.5;'>Kayƒ±t yok</div>"; return; }
    
    let active = recs.find(r => r.status === "Okuyor");
    let hist = recs.filter(r => r.status === "ƒ∞ade Etti");
    
    let h = "";
    if(active) {
        h += `<div class="list-item" style="background:rgba(245, 158, 11, 0.1); border-radius:10px; padding:10px; border:1px solid #f59e0b;">
            <div class="item-info"><b>${active.book}</b><span style="color:#f59e0b;">Okuyor ‚Ä¢ ${active.date}</span></div>
            <button class="btn-primary" style="width:auto; padding:8px 15px;" onclick="returnBook(${active.id})">ƒ∞ade Al</button>
        </div>`;
    }
    
    hist.forEach(r => {
        let btnText = r.comment ? "D√ºzenle" : "Yorumla";
        let btnCls = r.comment ? "btn-outline" : "btn-primary";
        h += `<div class="list-item">
            <div class="item-info"><b>${r.book}</b><span>${r.returnDate} ${r.rating?"‚≠ê"+r.rating:""}</span></div>
            <button class="${btnCls}" style="width:auto; padding:5px 12px;" onclick="openEdit(${r.id})">${btnText}</button>
        </div>`;
    });
    cont.innerHTML = h;
}

function renderActive() {
    let div = document.getElementById('activeList'); div.innerHTML="";
    let list = data.records.filter(r => r.status === "Okuyor");
    list.forEach(r => {
        div.innerHTML += `<div class="list-item">
            <div class="item-info"><b>${r.book}</b><span>${r.student}</span></div>
            <button class="btn-danger" style="width:auto; padding:5px 10px;" onclick="returnBook(${r.id})">ƒ∞ade Al</button>
        </div>`;
    });
}

function lend() {
    let s = document.getElementById('sInput').value, b = document.getElementById('bInput').value;
    if(!s||!b) return;
    let p = {action:"lend", id:Date.now(), date:new Date().toLocaleDateString("tr-TR"), student:s, book:b};
    data.records.unshift({id:p.id, student:s, book:b, status:"Okuyor", date:"Bug√ºn"});
    renderActive(); handleSearch(s); document.getElementById('bInput').value="";
    fetch(API, {method:"POST", body:JSON.stringify(p)});
}

function returnBook(id) {
    if(confirm("ƒ∞ade alƒ±nƒ±yor mu?")) {
        let r = data.records.find(x=>x.id==id);
        if(r) {
            r.status="ƒ∞ade Etti"; r.returnDate=new Date().toLocaleDateString("tr-TR");
            renderActive(); handleSearch(r.student);
            fetch(API, {method:"POST", body:JSON.stringify({action:"return", id:id, returnDate:r.returnDate})});
        }
    }
}

// 2. Kƒ∞TAPLAR
function renderBooks() {
    let val = document.getElementById('bookSearch').value.toLowerCase();
    let div = document.getElementById('bookListDiv'); div.innerHTML="";
    let list = data.books.filter(b => b.toLowerCase().includes(val));
    
    list.forEach(b => {
        div.innerHTML += `<div class="list-item">
            <div class="item-info"><b>${b}</b><span>${data.bookPages[b]||0} Sayfa</span></div>
            <button class="btn-outline" style="width:auto; padding:5px;" onclick="editBookInfo('${b}')">‚úèÔ∏è</button>
        </div>`;
    });
}
function editBookInfo(name) {
    let p = prompt("Yeni Sayfa Sayƒ±sƒ±:", data.bookPages[name]);
    let n = prompt("Yeni ƒ∞sim (Deƒüi≈ümeyecekse aynƒ± kalsƒ±n):", name);
    if(n) {
        fetch(API, {method:"POST", body:JSON.stringify({action:"edit_book", oldName:name, newName:n, newPage:p})});
        alert("G√ºncellendi");
    }
}
function addBook() {
    let n=document.getElementById('newBookName').value, p=document.getElementById('newBookPage').value;
    if(n) fetch(API, {method:"POST", body:JSON.stringify({action:"add_book", name:n, page:p})});
    alert("Eklendi");
}

// 3. RAPOR
function genReport() {
    let s = document.getElementById('repInput').value; if(!s) return;
    let my = data.records.filter(r => r.student === s && r.status === "ƒ∞ade Etti");
    let act = data.records.find(r => r.student === s && r.status === "Okuyor");
    
    let txt = `Sayƒ±n Velimiz,\n\n‚ú® "Her kitap ke≈üfedilmeyi bekleyen ayrƒ± bir d√ºnyadƒ±r."\n\n√ñƒürencimiz *${s}*, bu d√∂nem toplam *${my.length}* kitap okumu≈ütur.\n\n`;
    if(act) txt += `üî¥ *≈ûu An Okuduƒüu:*\n- ${act.book}\n\n`;
    txt += `üìö *Ke≈üfettiƒüi D√ºnyalar:*\n`;
    my.slice(0,10).forEach((r,i) => txt += `${i+1}. ${r.book} (‚úÖ Okudu)\n`);
    txt += `\nƒ∞lginiz i√ßin te≈üekk√ºrler.\nSƒ±nƒ±f √ñƒüretmeni`;
    
    document.getElementById('reportView').classList.remove('hidden');
    document.getElementById('reportText').innerText = txt;
    
    // Uzay Yolu
    let cont = document.getElementById('journeyMap');
    let path = document.getElementById('journeyPath');
    cont.querySelectorAll('.station, .astronaut').forEach(e => e.remove());
    let w = cont.offsetWidth;
    let d = `M ${w*0.2} 50 C ${w*0.8} 150, ${w*0.8} 250, ${w*0.2} 350 S ${w*0.8} 450, ${w*0.5} 480`;
    path.setAttribute('d', d);
    
    let goals = [0, data.settings.silver, data.settings.gold, data.settings.gold+5, data.settings.gold+10];
    let titles = ["Ba≈ülangƒ±√ß", "G√ºm√º≈ü", "Altƒ±n", "Usta", "Efsane"];
    
    goals.forEach((g,i) => {
        let y = 50 + (i*80);
        let x = (i%2===0) ? w*0.2 : w*0.8;
        let st = document.createElement('div'); st.className = `station ${my.length>=g?'active':''}`;
        st.style.left = x+"px"; st.style.top = y+"px";
        st.innerHTML = `<span>${titles[i]}<br>${g}</span>`;
        if(my.length >= g && (i===goals.length-1 || my.length < goals[i+1])) {
            st.innerHTML += `<div class="astronaut">üöÄ</div>`;
        }
        cont.appendChild(st);
    });
}
function copyReport() { navigator.clipboard.writeText(document.getElementById('reportText').innerText); alert("Kopyalandƒ±"); }

// 4. ƒ∞STATƒ∞STƒ∞K
function renderStats() {
    let div = document.getElementById('statsList'); div.innerHTML="";
    let counts = {};
    data.records.forEach(r => { if(r.status==="ƒ∞ade Etti") {
        if(!counts[r.student]) counts[r.student] = {c:0, p:0};
        counts[r.student].c++; counts[r.student].p += parseInt(data.bookPages[r.book])||0;
    }});
    
    let sorted = Object.keys(counts).map(k => ({n:k, ...counts[k]})).sort((a,b) => b.c - a.c);
    
    // Toplam
    let total = sorted.reduce((a,b) => a+b.c, 0);
    document.getElementById('targetTxt').innerText = `${total} / ${data.settings.target} Kitap`;
    document.getElementById('progBar').style.width = Math.min(100, (total/data.settings.target)*100) + "%";
    
    sorted.forEach((s,i) => {
        let rank = RANKS[0].t;
        for(let j=0; j<RANKS.length; j++) if(s.c >= RANKS[j].c) rank = RANKS[j].t;
        
        let g = Math.floor(s.c / data.settings.gold);
        let si = Math.floor(s.c / data.settings.silver);
        let medals = "ü•á".repeat(g) + "ü•à".repeat(si);
        
        div.innerHTML += `<div class="list-item">
            <div style="font-weight:bold; width:30px;">${i+1}</div>
            <div class="item-info" style="flex:1;"><b>${s.n}</b><span>${rank} ${medals}</span></div>
            <div style="text-align:right;"><b>${s.c}</b> Kitap<br><small>${s.p} Syf</small></div>
        </div>`;
    });
}

// 5. AYARLAR
function saveSettings() {
    let t=document.getElementById('setT').value, s=document.getElementById('setS').value, g=document.getElementById('setG').value;
    fetch(API, {method:"POST", body:JSON.stringify({action:"save_settings", target:t, silver:s, gold:g})});
    alert("Kaydedildi");
}
function addStudent() {
    let n=document.getElementById('newStudName').value, p=document.getElementById('newStudPass').value;
    if(n) fetch(API, {method:"POST", body:JSON.stringify({action:"add_student", name:n, pass:p})});
    alert("Eklendi");
}

// MODAL
function openEdit(id) {
    let r = data.records.find(x=>x.id==id);
    document.getElementById('editId').value = id;
    document.getElementById('editTitle').innerText = r.student + " - " + r.book;
    document.getElementById('editComment').value = r.comment || "";
    document.getElementById('editCard').value = r.cardId || "";
    document.getElementById('editModal').style.display = 'flex';
}
function setRate(n) { tempRate = n; }
function saveEdit() {
    let id = document.getElementById('editId').value;
    let c = document.getElementById('editComment').value;
    let cid = document.getElementById('editCard').value;
    let r = data.records.find(x=>x.id==id);
    if(r) { r.comment=c; r.cardId=cid; r.rating=tempRate || r.rating; }
    handleSearch(r.student);
    fetch(API, {method:"POST", body:JSON.stringify({action:"return", id:id, comment:c, cardId:cid, rating:tempRate})});
    document.getElementById('editModal').style.display='none';
}

// YARDIMCILAR
function tab(t,b) {
    document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
    document.getElementById('tab-'+t).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
    if(b) b.classList.add('active');
}
function clearInp(id) { document.getElementById(id).value=""; document.getElementById(id).focus(); }
function toggleTheme() { document.body.classList.toggle('light-mode'); }
</script>
</body>
</html>
